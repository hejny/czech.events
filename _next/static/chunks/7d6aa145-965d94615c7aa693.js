"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[773],{3737:function(e,n,t){t.d(n,{c:function(){return R}});var r=t(274),a=t(7316),i=t(5128),s=t(8956),o=t(6556),c=t(3003),u=t(5838),m=t(879),l=t(124),h=t(9033),p=t(9396),E=t(9652),d=t(1959),f=t(2611),T=t(4894),A=t(5738),N=t(3298),y=t(1444),R=function(e){function n(n,t){var r=e.call(this)||this;return r.driver=n,r.connection=n.connection,r.mode=t,r.broadcaster=new T.a(r),r}return(0,r.ZT)(n,e),n.prototype.connect=function(){var e=this;return this.databaseConnection?Promise.resolve(this.databaseConnection):(this.databaseConnectionPromise||("slave"===this.mode&&this.driver.isReplicated?this.databaseConnectionPromise=this.driver.obtainSlaveConnection().then(function(n){var t=(0,r.CR)(n,2),a=t[0],i=t[1];e.driver.connectedQueryRunners.push(e),e.databaseConnection=a;var s=function(){return e.release()};return e.releaseCallback=function(){e.databaseConnection.removeListener("error",s),i()},e.databaseConnection.on("error",s),e.databaseConnection}):this.databaseConnectionPromise=this.driver.obtainMasterConnection().then(function(n){var t=(0,r.CR)(n,2),a=t[0],i=t[1];e.driver.connectedQueryRunners.push(e),e.databaseConnection=a;var s=function(){return e.release()};return e.releaseCallback=function(){e.databaseConnection.removeListener("error",s),i()},e.databaseConnection.on("error",s),e.databaseConnection})),this.databaseConnectionPromise)},n.prototype.release=function(){if(this.isReleased)return Promise.resolve();this.isReleased=!0,this.releaseCallback&&this.releaseCallback();var e=this.driver.connectedQueryRunners.indexOf(this);return -1!==e&&this.driver.connectedQueryRunners.splice(e),Promise.resolve()},n.prototype.startTransaction=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(this.isTransactionActive)throw new s.S;if(n=new y.D,this.broadcaster.broadcastBeforeTransactionStartEvent(n),!(n.promises.length>0))return[3,2];return[4,Promise.all(n.promises)];case 1:r.sent(),r.label=2;case 2:return this.isTransactionActive=!0,[4,this.query("START TRANSACTION")];case 3:if(r.sent(),!e)return[3,5];return[4,this.query("SET TRANSACTION ISOLATION LEVEL "+e)];case 4:r.sent(),r.label=5;case 5:if(t=new y.D,this.broadcaster.broadcastAfterTransactionStartEvent(t),!(t.promises.length>0))return[3,7];return[4,Promise.all(t.promises)];case 6:r.sent(),r.label=7;case 7:return[2]}})})},n.prototype.commitTransaction=function(){return(0,r.mG)(this,void 0,void 0,function(){var e,n;return(0,r.Jh)(this,function(t){switch(t.label){case 0:if(!this.isTransactionActive)throw new o.W;if(e=new y.D,this.broadcaster.broadcastBeforeTransactionCommitEvent(e),!(e.promises.length>0))return[3,2];return[4,Promise.all(e.promises)];case 1:t.sent(),t.label=2;case 2:return[4,this.query("COMMIT")];case 3:if(t.sent(),this.isTransactionActive=!1,n=new y.D,this.broadcaster.broadcastAfterTransactionCommitEvent(n),!(n.promises.length>0))return[3,5];return[4,Promise.all(n.promises)];case 4:t.sent(),t.label=5;case 5:return[2]}})})},n.prototype.rollbackTransaction=function(){return(0,r.mG)(this,void 0,void 0,function(){var e,n;return(0,r.Jh)(this,function(t){switch(t.label){case 0:if(!this.isTransactionActive)throw new o.W;if(e=new y.D,this.broadcaster.broadcastBeforeTransactionRollbackEvent(e),!(e.promises.length>0))return[3,2];return[4,Promise.all(e.promises)];case 1:t.sent(),t.label=2;case 2:return[4,this.query("ROLLBACK")];case 3:if(t.sent(),this.isTransactionActive=!1,n=new y.D,this.broadcaster.broadcastAfterTransactionRollbackEvent(n),!(n.promises.length>0))return[3,5];return[4,Promise.all(n.promises)];case 4:t.sent(),t.label=5;case 5:return[2]}})})},n.prototype.query=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,s,o,c,u,m;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(this.isReleased)throw new i.Y;return[4,this.connect()];case 1:t=r.sent(),this.driver.connection.logger.logQuery(e,n,this),r.label=2;case 2:return r.trys.push([2,4,,5]),s=+new Date,[4,t.query(e,n)];case 3:switch(o=r.sent(),c=this.driver.connection.options.maxQueryExecutionTime,u=+new Date-s,c&&u>c&&this.driver.connection.logger.logQuerySlow(u,e,n,this),o.command){case"DELETE":case"UPDATE":return[2,[o.rows,o.rowCount]];default:return[2,o.rows]}return[3,5];case 4:throw m=r.sent(),this.driver.connection.logger.logQueryError(m,e,n,this),new a.O(e,n,m);case 5:return[2]}})})},n.prototype.stream=function(e,n,t,a){var s=this,o=this.driver.loadStreamDependency();if(this.isReleased)throw new i.Y;return new Promise(function(i,c){return(0,r.mG)(s,void 0,void 0,function(){var s,u;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,this.connect()];case 1:return s=r.sent(),this.driver.connection.logger.logQuery(e,n,this),u=s.query(new o(e,n)),t&&u.on("end",t),a&&u.on("error",a),i(u),[3,3];case 2:return c(r.sent()),[3,3];case 3:return[2]}})})})},n.prototype.getDatabases=function(){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){return[2,Promise.resolve([])]})})},n.prototype.getSchemas=function(e){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){return[2,Promise.resolve([])]})})},n.prototype.hasDatabase=function(e){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){return[2,Promise.resolve(!1)]})})},n.prototype.hasSchema=function(e){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(n){switch(n.label){case 0:return[4,this.query('SELECT * FROM "information_schema"."schemata" WHERE "schema_name" = \''+e+"'")];case 1:return[2,!!n.sent().length]}})})},n.prototype.hasTable=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return t='SELECT * FROM "information_schema"."tables" WHERE "table_schema" = '+(n=this.parseTableName(e)).schema+' AND "table_name" = '+n.tableName,[4,this.query(t)];case 1:return[2,!!r.sent().length]}})})},n.prototype.hasColumn=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return a='SELECT * FROM "information_schema"."columns" WHERE "table_schema" = '+(t=this.parseTableName(e)).schema+' AND "table_name" = '+t.tableName+' AND "column_name" = \''+n+"'",[4,this.query(a)];case 1:return[2,!!r.sent().length]}})})},n.prototype.createDatabase=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){switch(e.label){case 0:return[4,Promise.resolve()];case 1:return e.sent(),[2]}})})},n.prototype.dropDatabase=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){return[2,Promise.resolve()]})})},n.prototype.createSchema=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return t=n?'CREATE SCHEMA IF NOT EXISTS "'+e+'"':'CREATE SCHEMA "'+e+'"',a='DROP SCHEMA "'+e+'" CASCADE',[4,this.executeQueries(new N.A(t),new N.A(a))];case 1:return r.sent(),[2]}})})},n.prototype.dropSchema=function(e,n,t){return(0,r.mG)(this,void 0,void 0,function(){var a,i,s;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return a=-1===e.indexOf(".")?e:e.split(".")[0],i=n?'DROP SCHEMA IF EXISTS "'+a+'" '+(t?"CASCADE":""):'DROP SCHEMA "'+a+'" '+(t?"CASCADE":""),s='CREATE SCHEMA "'+a+'"',[4,this.executeQueries(new N.A(i),new N.A(s))];case 1:return r.sent(),[2]}})})},n.prototype.createTable=function(e,n,t,a){return void 0===n&&(n=!1),void 0===t&&(t=!0),void 0===a&&(a=!0),(0,r.mG)(this,void 0,void 0,function(){var i,s,o=this;return(0,r.Jh)(this,function(c){switch(c.label){case 0:if(!n)return[3,2];return[4,this.hasTable(e)];case 1:if(c.sent())return[2,Promise.resolve()];c.label=2;case 2:return i=[],s=[],[4,Promise.all(e.columns.filter(function(e){return"enum"===e.type||"simple-enum"===e.type}).map(function(n){return(0,r.mG)(o,void 0,void 0,function(){return(0,r.Jh)(this,function(t){switch(t.label){case 0:return[4,this.hasEnumType(e,n)];case 1:return t.sent()||(i.push(this.createEnumTypeSql(e,n)),s.push(this.dropEnumTypeSql(e,n))),[2,Promise.resolve()]}})})}))];case 3:return c.sent(),i.push(this.createTableSql(e,t)),s.push(this.dropTableSql(e)),t&&e.foreignKeys.forEach(function(n){return s.push(o.dropForeignKeySql(e,n))}),a&&e.indices.forEach(function(n){n.name||(n.name=o.connection.namingStrategy.indexName(e.name,n.columnNames,n.where)),i.push(o.createIndexSql(e,n)),s.push(o.dropIndexSql(e,n))}),[4,this.executeQueries(i,s)];case 4:return c.sent(),[2]}})})},n.prototype.dropTable=function(e,n,t,a){return void 0===t&&(t=!0),void 0===a&&(a=!0),(0,r.mG)(this,void 0,void 0,function(){var i,s,o,c,m,l=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!n)return[3,2];return[4,this.hasTable(e)];case 1:if(!r.sent())return[2,Promise.resolve()];r.label=2;case 2:return i=t,s=e instanceof u.i?e.name:e,[4,this.getCachedTable(s)];case 3:return o=r.sent(),c=[],m=[],a&&o.indices.forEach(function(e){c.push(l.dropIndexSql(o,e)),m.push(l.createIndexSql(o,e))}),t&&o.foreignKeys.forEach(function(e){return c.push(l.dropForeignKeySql(o,e))}),c.push(this.dropTableSql(o)),m.push(this.createTableSql(o,i)),[4,this.executeQueries(c,m)];case 4:return r.sent(),[2]}})})},n.prototype.createView=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,a,i,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return t=[],(n=[]).push(this.createViewSql(e)),i=(a=n).push,[4,this.insertViewDefinitionSql(e)];case 1:return i.apply(a,[r.sent()]),t.push(this.dropViewSql(e)),o=(s=t).push,[4,this.deleteViewDefinitionSql(e)];case 2:return o.apply(s,[r.sent()]),[4,this.executeQueries(n,t)];case 3:return r.sent(),[2]}})})},n.prototype.dropView=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,a,i,s,o,c,u;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return n=e instanceof f.G?e.name:e,[4,this.getCachedView(n)];case 1:return t=r.sent(),i=[],o=(s=a=[]).push,[4,this.deleteViewDefinitionSql(t)];case 2:return o.apply(s,[r.sent()]),a.push(this.dropViewSql(t)),u=(c=i).push,[4,this.insertViewDefinitionSql(t)];case 3:return u.apply(c,[r.sent()]),i.push(this.createViewSql(t)),[4,this.executeQueries(a,i)];case 4:return r.sent(),[2]}})})},n.prototype.renameTable=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o,c,m,l,h,p,E,d,f,T,A,y,R,C=this;return(0,r.Jh)(this,function(v){switch(v.label){case 0:if(t=[],a=[],!(e instanceof u.i))return[3,1];return s=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:s=v.sent(),v.label=3;case 3:o=(i=s).clone(),c=-1===i.name.indexOf(".")?i.name:i.name.split(".")[1],m=-1===i.name.indexOf(".")?void 0:i.name.split(".")[0],o.name=m?m+"."+n:n,t.push(new N.A("ALTER TABLE "+this.escapePath(i)+' RENAME TO "'+n+'"')),a.push(new N.A("ALTER TABLE "+this.escapePath(o)+' RENAME TO "'+c+'"')),o.primaryColumns.length>0&&(l=o.primaryColumns.map(function(e){return e.name}),h=this.connection.namingStrategy.primaryKeyName(i,l),p=this.connection.namingStrategy.primaryKeyName(o,l),t.push(new N.A("ALTER TABLE "+this.escapePath(o)+' RENAME CONSTRAINT "'+h+'" TO "'+p+'"')),a.push(new N.A("ALTER TABLE "+this.escapePath(o)+' RENAME CONSTRAINT "'+p+'" TO "'+h+'"'))),o.uniques.forEach(function(e){var n=C.connection.namingStrategy.uniqueConstraintName(o,e.columnNames);t.push(new N.A("ALTER TABLE "+C.escapePath(o)+' RENAME CONSTRAINT "'+e.name+'" TO "'+n+'"')),a.push(new N.A("ALTER TABLE "+C.escapePath(o)+' RENAME CONSTRAINT "'+n+'" TO "'+e.name+'"')),e.name=n}),o.indices.forEach(function(e){var n=C.extractSchema(o),r=C.connection.namingStrategy.indexName(o,e.columnNames,e.where),i=n?'ALTER INDEX "'+n+'"."'+e.name+'" RENAME TO "'+r+'"':'ALTER INDEX "'+e.name+'" RENAME TO "'+r+'"',s=n?'ALTER INDEX "'+n+'"."'+r+'" RENAME TO "'+e.name+'"':'ALTER INDEX "'+r+'" RENAME TO "'+e.name+'"';t.push(new N.A(i)),a.push(new N.A(s)),e.name=r}),o.foreignKeys.forEach(function(e){var n=C.connection.namingStrategy.foreignKeyName(o,e.columnNames,e.referencedTableName,e.referencedColumnNames);t.push(new N.A("ALTER TABLE "+C.escapePath(o)+' RENAME CONSTRAINT "'+e.name+'" TO "'+n+'"')),a.push(new N.A("ALTER TABLE "+C.escapePath(o)+' RENAME CONSTRAINT "'+n+'" TO "'+e.name+'"')),e.name=n}),E=o.columns.filter(function(e){return"enum"===e.type||"simple-enum"===e.type}),v.label=4;case 4:v.trys.push([4,9,10,11]),f=(d=(0,r.XA)(E)).next(),v.label=5;case 5:if(f.done)return[3,8];return T=f.value,[4,this.getEnumTypeName(i,T)];case 6:A=v.sent(),t.push(new N.A('ALTER TYPE "'+A.enumTypeSchema+'"."'+A.enumTypeName+'" RENAME TO '+this.buildEnumName(o,T,!1))),a.push(new N.A("ALTER TYPE "+this.buildEnumName(o,T)+' RENAME TO "'+A.enumTypeName+'"')),v.label=7;case 7:return f=d.next(),[3,5];case 8:return[3,11];case 9:return y={error:v.sent()},[3,11];case 10:try{f&&!f.done&&(R=d.return)&&R.call(d)}finally{if(y)throw y.error}return[7];case 11:return[4,this.executeQueries(t,a)];case 12:return v.sent(),[2]}})})},n.prototype.addColumn=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o,c,m,l,h,p,E,f;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:if(i=(t=a).clone(),s=[],o=[],!("enum"===n.type||"simple-enum"===n.type))return[3,5];return[4,this.hasEnumType(t,n)];case 4:r.sent()||(s.push(this.createEnumTypeSql(t,n)),o.push(this.dropEnumTypeSql(t,n))),r.label=5;case 5:return s.push(new N.A("ALTER TABLE "+this.escapePath(t)+" ADD "+this.buildCreateColumnSql(t,n))),o.push(new N.A("ALTER TABLE "+this.escapePath(t)+' DROP COLUMN "'+n.name+'"')),n.isPrimary&&((c=i.primaryColumns).length>0&&(m=this.connection.namingStrategy.primaryKeyName(i.name,c.map(function(e){return e.name})),l=c.map(function(e){return'"'+e.name+'"'}).join(", "),s.push(new N.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+m+'"')),o.push(new N.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+m+'" PRIMARY KEY ('+l+")"))),c.push(n),h=this.connection.namingStrategy.primaryKeyName(i.name,c.map(function(e){return e.name})),p=c.map(function(e){return'"'+e.name+'"'}).join(", "),s.push(new N.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+h+'" PRIMARY KEY ('+p+")")),o.push(new N.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+h+'"'))),(E=i.indices.find(function(e){return 1===e.columnNames.length&&e.columnNames[0]===n.name}))&&(s.push(this.createIndexSql(t,E)),o.push(this.dropIndexSql(t,E))),n.isUnique&&(f=new d.v({name:this.connection.namingStrategy.uniqueConstraintName(t.name,[n.name]),columnNames:[n.name]}),i.uniques.push(f),s.push(new N.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+f.name+'" UNIQUE ("'+n.name+'")')),o.push(new N.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+f.name+'"'))),n.comment&&(s.push(new N.A("COMMENT ON COLUMN "+this.escapePath(t)+'."'+n.name+'" IS '+this.escapeComment(n.comment))),o.push(new N.A("COMMENT ON COLUMN "+this.escapePath(t)+'."'+n.name+'" IS '+this.escapeComment(n.comment)))),[4,this.executeQueries(s,o)];case 6:return r.sent(),i.addColumn(n),this.replaceCachedTable(t,i),[2]}})})},n.prototype.addColumns=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,7]),a=(t=(0,r.XA)(n)).next(),c.label=1;case 1:if(a.done)return[3,4];return i=a.value,[4,this.addColumn(e,i)];case 2:c.sent(),c.label=3;case 3:return a=t.next(),[3,1];case 4:return[3,7];case 5:return s={error:c.sent()},[3,7];case 6:try{a&&!a.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}return[7];case 7:return[2]}})})},n.prototype.renameColumn=function(e,n,t){return(0,r.mG)(this,void 0,void 0,function(){var a,i,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:if(a=i,!(s=n instanceof l.D?n:a.columns.find(function(e){return e.name===n})))throw Error('Column "'+n+'" was not found in the "'+a.name+'" table.');return t instanceof l.D?o=t:(o=s.clone()).name=t,[2,this.changeColumn(a,s,o)]}})})},n.prototype.changeColumn=function(e,n,t){return(0,r.mG)(this,void 0,void 0,function(){var a,i,s,o,c,m,h,p,E,f,T,y,R,C,v,b,S,L,O,g,w,_,P,I,D,q,x,U=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:if(s=(a=i).clone(),o=[],c=[],!(m=n instanceof l.D?n:a.columns.find(function(e){return e.name===n})))throw Error('Column "'+n+'" was not found in the "'+a.name+'" table.');if(!(m.type!==t.type||m.length!==t.length))return[3,6];return[4,this.dropColumn(a,m)];case 4:return r.sent(),[4,this.addColumn(a,t)];case 5:return r.sent(),s=a.clone(),[3,12];case 6:if(!(m.name!==t.name))return[3,9];if(o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' RENAME COLUMN "'+m.name+'" TO "'+t.name+'"')),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' RENAME COLUMN "'+t.name+'" TO "'+m.name+'"')),!("enum"===m.type||"simple-enum"===m.type))return[3,8];return[4,this.getEnumTypeName(a,m)];case 7:h=r.sent(),o.push(new N.A('ALTER TYPE "'+h.enumTypeSchema+'"."'+h.enumTypeName+'" RENAME TO '+this.buildEnumName(a,t,!1))),c.push(new N.A("ALTER TYPE "+this.buildEnumName(a,t)+' RENAME TO "'+h.enumTypeName+'"')),r.label=8;case 8:!0===m.isPrimary&&(E=(p=s.primaryColumns).map(function(e){return e.name}),f=this.connection.namingStrategy.primaryKeyName(s,E),E.splice(E.indexOf(m.name),1),E.push(t.name),T=this.connection.namingStrategy.primaryKeyName(s,E),o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' RENAME CONSTRAINT "'+f+'" TO "'+T+'"')),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' RENAME CONSTRAINT "'+T+'" TO "'+f+'"'))),!0===m.isGenerated&&"increment"===t.generationStrategy&&(y=this.extractSchema(a),R=this.buildSequenceName(a,m.name,void 0,!0,!0),C=this.buildSequenceName(a,t.name,void 0,!0,!0),v=y?'ALTER SEQUENCE "'+y+'"."'+R+'" RENAME TO "'+C+'"':'ALTER SEQUENCE "'+R+'" RENAME TO "'+C+'"',b=y?'ALTER SEQUENCE "'+y+'"."'+C+'" RENAME TO "'+R+'"':'ALTER SEQUENCE "'+C+'" RENAME TO "'+R+'"',o.push(new N.A(v)),c.push(new N.A(b))),s.findColumnUniques(m).forEach(function(e){e.columnNames.splice(e.columnNames.indexOf(m.name),1),e.columnNames.push(t.name);var n=U.connection.namingStrategy.uniqueConstraintName(s,e.columnNames);o.push(new N.A("ALTER TABLE "+U.escapePath(a)+' RENAME CONSTRAINT "'+e.name+'" TO "'+n+'"')),c.push(new N.A("ALTER TABLE "+U.escapePath(a)+' RENAME CONSTRAINT "'+n+'" TO "'+e.name+'"')),e.name=n}),s.findColumnIndices(m).forEach(function(e){e.columnNames.splice(e.columnNames.indexOf(m.name),1),e.columnNames.push(t.name);var n=U.extractSchema(a),r=U.connection.namingStrategy.indexName(s,e.columnNames,e.where),i=n?'ALTER INDEX "'+n+'"."'+e.name+'" RENAME TO "'+r+'"':'ALTER INDEX "'+e.name+'" RENAME TO "'+r+'"',u=n?'ALTER INDEX "'+n+'"."'+r+'" RENAME TO "'+e.name+'"':'ALTER INDEX "'+r+'" RENAME TO "'+e.name+'"';o.push(new N.A(i)),c.push(new N.A(u)),e.name=r}),s.findColumnForeignKeys(m).forEach(function(e){e.columnNames.splice(e.columnNames.indexOf(m.name),1),e.columnNames.push(t.name);var n=U.connection.namingStrategy.foreignKeyName(s,e.columnNames,e.referencedTableName,e.referencedColumnNames);o.push(new N.A("ALTER TABLE "+U.escapePath(a)+' RENAME CONSTRAINT "'+e.name+'" TO "'+n+'"')),c.push(new N.A("ALTER TABLE "+U.escapePath(a)+' RENAME CONSTRAINT "'+n+'" TO "'+e.name+'"')),e.name=n}),S=s.columns.find(function(e){return e.name===m.name}),s.columns[s.columns.indexOf(S)].name=t.name,m.name=t.name,r.label=9;case 9:if((t.precision!==m.precision||t.scale!==m.scale)&&(o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" TYPE '+this.driver.createFullType(t))),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" TYPE '+this.driver.createFullType(m)))),!(("enum"===t.type||"simple-enum"===t.type)&&("enum"===m.type||"simple-enum"===m.type)&&!A.s.isArraysEqual(t.enum,m.enum)))return[3,11];return L=this.buildEnumName(a,t),O=t.isArray?"[]":"",g=this.buildEnumName(a,t,!0,!1,!0),w=this.buildEnumName(a,t,!1,!1,!0),[4,this.getEnumTypeName(a,m)];case 10:_=r.sent(),o.push(new N.A('ALTER TYPE "'+_.enumTypeSchema+'"."'+_.enumTypeName+'" RENAME TO '+w)),c.push(new N.A("ALTER TYPE "+g+' RENAME TO  "'+_.enumTypeName+'"')),o.push(this.createEnumTypeSql(a,t)),c.push(this.dropEnumTypeSql(a,m)),null!==t.default&&void 0!==t.default&&(o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" DROP DEFAULT')),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" SET DEFAULT '+t.default))),P=""+L+O+' USING "'+t.name+'"::"text"::'+L+O,I=""+g+O+' USING "'+t.name+'"::"text"::'+g+O,o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" TYPE '+P)),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" TYPE '+I)),null!==t.default&&void 0!==t.default&&(o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" SET DEFAULT '+t.default)),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" DROP DEFAULT'))),o.push(this.dropEnumTypeSql(a,t,g)),c.push(this.createEnumTypeSql(a,m,g)),r.label=11;case 11:m.isNullable!==t.isNullable&&(t.isNullable?(o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+m.name+'" DROP NOT NULL')),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+m.name+'" SET NOT NULL'))):(o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+m.name+'" SET NOT NULL')),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+m.name+'" DROP NOT NULL')))),m.comment!==t.comment&&(o.push(new N.A("COMMENT ON COLUMN "+this.escapePath(a)+'."'+m.name+'" IS '+this.escapeComment(t.comment))),c.push(new N.A("COMMENT ON COLUMN "+this.escapePath(a)+'."'+t.name+'" IS '+this.escapeComment(m.comment)))),t.isPrimary!==m.isPrimary&&((p=s.primaryColumns).length>0&&(D=this.connection.namingStrategy.primaryKeyName(s.name,p.map(function(e){return e.name})),E=p.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' DROP CONSTRAINT "'+D+'"')),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ADD CONSTRAINT "'+D+'" PRIMARY KEY ('+E+")"))),!0===t.isPrimary?(p.push(t),s.columns.find(function(e){return e.name===t.name}).isPrimary=!0,D=this.connection.namingStrategy.primaryKeyName(s.name,p.map(function(e){return e.name})),E=p.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ADD CONSTRAINT "'+D+'" PRIMARY KEY ('+E+")")),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' DROP CONSTRAINT "'+D+'"'))):(q=p.find(function(e){return e.name===t.name}),p.splice(p.indexOf(q),1),s.columns.find(function(e){return e.name===t.name}).isPrimary=!1,p.length>0&&(D=this.connection.namingStrategy.primaryKeyName(s.name,p.map(function(e){return e.name})),E=p.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ADD CONSTRAINT "'+D+'" PRIMARY KEY ('+E+")")),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' DROP CONSTRAINT "'+D+'"'))))),t.isUnique!==m.isUnique&&(!0===t.isUnique?(x=new d.v({name:this.connection.namingStrategy.uniqueConstraintName(a.name,[t.name]),columnNames:[t.name]}),s.uniques.push(x),o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ADD CONSTRAINT "'+x.name+'" UNIQUE ("'+t.name+'")')),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' DROP CONSTRAINT "'+x.name+'"'))):(x=s.uniques.find(function(e){return 1===e.columnNames.length&&!!e.columnNames.find(function(e){return e===t.name})}),s.uniques.splice(s.uniques.indexOf(x),1),o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' DROP CONSTRAINT "'+x.name+'"')),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ADD CONSTRAINT "'+x.name+'" UNIQUE ("'+t.name+'")')))),m.isGenerated!==t.isGenerated&&"uuid"!==t.generationStrategy&&(!0===t.isGenerated?(o.push(new N.A("CREATE SEQUENCE "+this.buildSequenceName(a,t)+" OWNED BY "+this.escapePath(a)+'."'+t.name+'"')),c.push(new N.A("DROP SEQUENCE "+this.buildSequenceName(a,t))),o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+"\" SET DEFAULT nextval('"+this.buildSequenceName(a,t,void 0,!0)+"')")),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" DROP DEFAULT'))):(o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" DROP DEFAULT')),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+"\" SET DEFAULT nextval('"+this.buildSequenceName(a,t,void 0,!0)+"')")),o.push(new N.A("DROP SEQUENCE "+this.buildSequenceName(a,t))),c.push(new N.A("CREATE SEQUENCE "+this.buildSequenceName(a,t)+" OWNED BY "+this.escapePath(a)+'."'+t.name+'"')))),t.default!==m.default&&(null!==t.default&&void 0!==t.default?(o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" SET DEFAULT '+t.default)),null!==m.default&&void 0!==m.default?c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" SET DEFAULT '+m.default)):c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" DROP DEFAULT'))):null!==m.default&&void 0!==m.default&&(o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" DROP DEFAULT')),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" SET DEFAULT '+m.default)))),((t.spatialFeatureType||"").toLowerCase()!==(m.spatialFeatureType||"").toLowerCase()||t.srid!==m.srid)&&(o.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" TYPE '+this.driver.createFullType(t))),c.push(new N.A("ALTER TABLE "+this.escapePath(a)+' ALTER COLUMN "'+t.name+'" TYPE '+this.driver.createFullType(m)))),r.label=12;case 12:return[4,this.executeQueries(o,c)];case 13:return r.sent(),this.replaceCachedTable(a,s),[2]}})})},n.prototype.changeColumns=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o,c,u;return(0,r.Jh)(this,function(m){switch(m.label){case 0:m.trys.push([0,5,6,7]),a=(t=(0,r.XA)(n)).next(),m.label=1;case 1:if(a.done)return[3,4];return s=(i=a.value).oldColumn,o=i.newColumn,[4,this.changeColumn(e,s,o)];case 2:m.sent(),m.label=3;case 3:return a=t.next(),[3,1];case 4:return[3,7];case 5:return c={error:m.sent()},[3,7];case 6:try{a&&!a.done&&(u=t.return)&&u.call(t)}finally{if(c)throw c.error}return[7];case 7:return[2]}})})},n.prototype.dropColumn=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o,c,m,h,p,E,d,f,T,A,y;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:if(t=a,!(i=n instanceof l.D?n:t.findColumnByName(n)))throw Error('Column "'+n+'" was not found in table "'+t.name+'"');if(s=t.clone(),o=[],c=[],i.isPrimary&&(m=this.connection.namingStrategy.primaryKeyName(s.name,s.primaryColumns.map(function(e){return e.name})),h=s.primaryColumns.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new N.A("ALTER TABLE "+this.escapePath(s)+' DROP CONSTRAINT "'+m+'"')),c.push(new N.A("ALTER TABLE "+this.escapePath(s)+' ADD CONSTRAINT "'+m+'" PRIMARY KEY ('+h+")")),s.findColumnByName(i.name).isPrimary=!1,s.primaryColumns.length>0&&(p=this.connection.namingStrategy.primaryKeyName(s.name,s.primaryColumns.map(function(e){return e.name})),E=s.primaryColumns.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new N.A("ALTER TABLE "+this.escapePath(s)+' ADD CONSTRAINT "'+p+'" PRIMARY KEY ('+E+")")),c.push(new N.A("ALTER TABLE "+this.escapePath(s)+' DROP CONSTRAINT "'+p+'"')))),(d=s.indices.find(function(e){return 1===e.columnNames.length&&e.columnNames[0]===i.name}))&&(s.indices.splice(s.indices.indexOf(d),1),o.push(this.dropIndexSql(t,d)),c.push(this.createIndexSql(t,d))),(f=s.checks.find(function(e){return!!e.columnNames&&1===e.columnNames.length&&e.columnNames[0]===i.name}))&&(s.checks.splice(s.checks.indexOf(f),1),o.push(this.dropCheckConstraintSql(t,f)),c.push(this.createCheckConstraintSql(t,f))),(T=s.uniques.find(function(e){return 1===e.columnNames.length&&e.columnNames[0]===i.name}))&&(s.uniques.splice(s.uniques.indexOf(T),1),o.push(this.dropUniqueConstraintSql(t,T)),c.push(this.createUniqueConstraintSql(t,T))),o.push(new N.A("ALTER TABLE "+this.escapePath(t)+' DROP COLUMN "'+i.name+'"')),c.push(new N.A("ALTER TABLE "+this.escapePath(t)+" ADD "+this.buildCreateColumnSql(t,i))),!("enum"===i.type||"simple-enum"===i.type))return[3,6];return[4,this.hasEnumType(t,i)];case 4:if(!r.sent())return[3,6];return[4,this.getEnumTypeName(t,i)];case 5:y='"'+(A=r.sent()).enumTypeSchema+'"."'+A.enumTypeName+'"',o.push(this.dropEnumTypeSql(t,i,y)),c.push(this.createEnumTypeSql(t,i,y)),r.label=6;case 6:return[4,this.executeQueries(o,c)];case 7:return r.sent(),s.removeColumn(i),this.replaceCachedTable(t,s),[2]}})})},n.prototype.dropColumns=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,7]),a=(t=(0,r.XA)(n)).next(),c.label=1;case 1:if(a.done)return[3,4];return i=a.value,[4,this.dropColumn(e,i)];case 2:c.sent(),c.label=3;case 3:return a=t.next(),[3,1];case 4:return[3,7];case 5:return s={error:c.sent()},[3,7];case 6:try{a&&!a.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}return[7];case 7:return[2]}})})},n.prototype.createPrimaryKey=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:return i=(t=a).clone(),s=this.createPrimaryKeySql(t,n),i.columns.forEach(function(e){n.find(function(n){return n===e.name})&&(e.isPrimary=!0)}),o=this.dropPrimaryKeySql(i),[4,this.executeQueries(s,o)];case 4:return r.sent(),this.replaceCachedTable(t,i),[2]}})})},n.prototype.updatePrimaryKeys=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o,c,m,l,h,p,E;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:return i=(t=a).clone(),s=n.map(function(e){return e.name}),o=[],c=[],(m=i.primaryColumns).length>0&&(l=this.connection.namingStrategy.primaryKeyName(i.name,m.map(function(e){return e.name})),h=m.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new N.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+l+'"')),c.push(new N.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+l+'" PRIMARY KEY ('+h+")"))),i.columns.filter(function(e){return -1!==s.indexOf(e.name)}).forEach(function(e){return e.isPrimary=!0}),p=this.connection.namingStrategy.primaryKeyName(i.name,s),E=s.map(function(e){return'"'+e+'"'}).join(", "),o.push(new N.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+p+'" PRIMARY KEY ('+E+")")),c.push(new N.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+p+'"')),[4,this.executeQueries(o,c)];case 4:return r.sent(),this.replaceCachedTable(t,i),[2]}})})},n.prototype.dropPrimaryKey=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,a,i;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return t=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:t=r.sent(),r.label=3;case 3:return n=t,a=this.dropPrimaryKeySql(n),i=this.createPrimaryKeySql(n,n.primaryColumns.map(function(e){return e.name})),[4,this.executeQueries(a,i)];case 4:return r.sent(),n.primaryColumns.forEach(function(e){e.isPrimary=!1}),[2]}})})},n.prototype.createUniqueConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:return t=a,n.name||(n.name=this.connection.namingStrategy.uniqueConstraintName(t.name,n.columnNames)),i=this.createUniqueConstraintSql(t,n),s=this.dropUniqueConstraintSql(t,n),[4,this.executeQueries(i,s)];case 4:return r.sent(),t.addUniqueConstraint(n),[2]}})})},n.prototype.createUniqueConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,7]),a=(t=(0,r.XA)(n)).next(),c.label=1;case 1:if(a.done)return[3,4];return i=a.value,[4,this.createUniqueConstraint(e,i)];case 2:c.sent(),c.label=3;case 3:return a=t.next(),[3,1];case 4:return[3,7];case 5:return s={error:c.sent()},[3,7];case 6:try{a&&!a.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}return[7];case 7:return[2]}})})},n.prototype.dropUniqueConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:if(t=a,!(i=n instanceof d.v?n:t.uniques.find(function(e){return e.name===n})))throw Error("Supplied unique constraint was not found in table "+t.name);return s=this.dropUniqueConstraintSql(t,i),o=this.createUniqueConstraintSql(t,i),[4,this.executeQueries(s,o)];case 4:return r.sent(),t.removeUniqueConstraint(i),[2]}})})},n.prototype.dropUniqueConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,7]),a=(t=(0,r.XA)(n)).next(),c.label=1;case 1:if(a.done)return[3,4];return i=a.value,[4,this.dropUniqueConstraint(e,i)];case 2:c.sent(),c.label=3;case 3:return a=t.next(),[3,1];case 4:return[3,7];case 5:return s={error:c.sent()},[3,7];case 6:try{a&&!a.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}return[7];case 7:return[2]}})})},n.prototype.createCheckConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:return t=a,n.name||(n.name=this.connection.namingStrategy.checkConstraintName(t.name,n.expression)),i=this.createCheckConstraintSql(t,n),s=this.dropCheckConstraintSql(t,n),[4,this.executeQueries(i,s)];case 4:return r.sent(),t.addCheckConstraint(n),[2]}})})},n.prototype.createCheckConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.createCheckConstraint(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.dropCheckConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:if(t=a,!(i=n instanceof m.r?n:t.checks.find(function(e){return e.name===n})))throw Error("Supplied check constraint was not found in table "+t.name);return s=this.dropCheckConstraintSql(t,i),o=this.createCheckConstraintSql(t,i),[4,this.executeQueries(s,o)];case 4:return r.sent(),t.removeCheckConstraint(i),[2]}})})},n.prototype.dropCheckConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.dropCheckConstraint(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.createExclusionConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:return t=a,n.name||(n.name=this.connection.namingStrategy.exclusionConstraintName(t.name,n.expression)),i=this.createExclusionConstraintSql(t,n),s=this.dropExclusionConstraintSql(t,n),[4,this.executeQueries(i,s)];case 4:return r.sent(),t.addExclusionConstraint(n),[2]}})})},n.prototype.createExclusionConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.createExclusionConstraint(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.dropExclusionConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:if(t=a,!(i=n instanceof h.N?n:t.exclusions.find(function(e){return e.name===n})))throw Error("Supplied exclusion constraint was not found in table "+t.name);return s=this.dropExclusionConstraintSql(t,i),o=this.createExclusionConstraintSql(t,i),[4,this.executeQueries(s,o)];case 4:return r.sent(),t.removeExclusionConstraint(i),[2]}})})},n.prototype.dropExclusionConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.dropExclusionConstraint(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.createForeignKey=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:return t=a,n.name||(n.name=this.connection.namingStrategy.foreignKeyName(t.name,n.columnNames,n.referencedTableName,n.referencedColumnNames)),i=this.createForeignKeySql(t,n),s=this.dropForeignKeySql(t,n),[4,this.executeQueries(i,s)];case 4:return r.sent(),t.addForeignKey(n),[2]}})})},n.prototype.createForeignKeys=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,7]),a=(t=(0,r.XA)(n)).next(),c.label=1;case 1:if(a.done)return[3,4];return i=a.value,[4,this.createForeignKey(e,i)];case 2:c.sent(),c.label=3;case 3:return a=t.next(),[3,1];case 4:return[3,7];case 5:return s={error:c.sent()},[3,7];case 6:try{a&&!a.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}return[7];case 7:return[2]}})})},n.prototype.dropForeignKey=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:if(t=a,!(i=n instanceof p.U?n:t.foreignKeys.find(function(e){return e.name===n})))throw Error("Supplied foreign key was not found in table "+t.name);return s=this.dropForeignKeySql(t,i),o=this.createForeignKeySql(t,i),[4,this.executeQueries(s,o)];case 4:return r.sent(),t.removeForeignKey(i),[2]}})})},n.prototype.dropForeignKeys=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,7]),a=(t=(0,r.XA)(n)).next(),c.label=1;case 1:if(a.done)return[3,4];return i=a.value,[4,this.dropForeignKey(e,i)];case 2:c.sent(),c.label=3;case 3:return a=t.next(),[3,1];case 4:return[3,7];case 5:return s={error:c.sent()},[3,7];case 6:try{a&&!a.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}return[7];case 7:return[2]}})})},n.prototype.createIndex=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:return t=a,n.name||(n.name=this.connection.namingStrategy.indexName(t.name,n.columnNames,n.where)),i=this.createIndexSql(t,n),s=this.dropIndexSql(t,n),[4,this.executeQueries(i,s)];case 4:return r.sent(),t.addIndex(n),[2]}})})},n.prototype.createIndices=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,7]),a=(t=(0,r.XA)(n)).next(),c.label=1;case 1:if(a.done)return[3,4];return i=a.value,[4,this.createIndex(e,i)];case 2:c.sent(),c.label=3;case 3:return a=t.next(),[3,1];case 4:return[3,7];case 5:return s={error:c.sent()},[3,7];case 6:try{a&&!a.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}return[7];case 7:return[2]}})})},n.prototype.dropIndex=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof u.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:if(t=a,!(i=n instanceof E.s?n:t.indices.find(function(e){return e.name===n})))throw Error("Supplied index was not found in table "+t.name);return s=this.dropIndexSql(t,i),o=this.createIndexSql(t,i),[4,this.executeQueries(s,o)];case 4:return r.sent(),t.removeIndex(i),[2]}})})},n.prototype.dropIndices=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,7]),a=(t=(0,r.XA)(n)).next(),c.label=1;case 1:if(a.done)return[3,4];return i=a.value,[4,this.dropIndex(e,i)];case 2:c.sent(),c.label=3;case 3:return a=t.next(),[3,1];case 4:return[3,7];case 5:return s={error:c.sent()},[3,7];case 6:try{a&&!a.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}return[7];case 7:return[2]}})})},n.prototype.clearTable=function(e){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(n){switch(n.label){case 0:return[4,this.query("TRUNCATE TABLE "+this.escapePath(e))];case 1:return n.sent(),[2]}})})},n.prototype.clearDatabase=function(){return(0,r.mG)(this,void 0,void 0,function(){var e,n,t,a,i,s=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return e=[],this.connection.entityMetadatas.filter(function(e){return e.schema}).forEach(function(n){e.find(function(e){return e===n.schema})||e.push(n.schema)}),e.push(this.driver.options.schema||"current_schema()"),n=e.map(function(e){return"current_schema()"===e?e:"'"+e+"'"}).join(", "),[4,this.startTransaction()];case 1:r.sent(),r.label=2;case 2:return r.trys.push([2,9,,14]),t='SELECT \'DROP VIEW IF EXISTS "\' || schemaname || \'"."\' || viewname || \'" CASCADE;\' as "query" FROM "pg_views" WHERE "schemaname" IN ('+n+") AND \"viewname\" NOT IN ('geography_columns', 'geometry_columns', 'raster_columns', 'raster_overviews')",[4,this.query(t)];case 3:return[4,Promise.all(r.sent().map(function(e){return s.query(e.query)}))];case 4:return r.sent(),a='SELECT \'DROP TABLE IF EXISTS "\' || schemaname || \'"."\' || tablename || \'" CASCADE;\' as "query" FROM "pg_tables" WHERE "schemaname" IN ('+n+") AND \"tablename\" NOT IN ('spatial_ref_sys')",[4,this.query(a)];case 5:return[4,Promise.all(r.sent().map(function(e){return s.query(e.query)}))];case 6:return r.sent(),[4,this.dropEnumTypes(n)];case 7:return r.sent(),[4,this.commitTransaction()];case 8:return r.sent(),[3,14];case 9:i=r.sent(),r.label=10;case 10:return r.trys.push([10,12,,13]),[4,this.rollbackTransaction()];case 11:case 12:return r.sent(),[3,13];case 13:throw i;case 14:return[2]}})})},n.prototype.loadViews=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,a,i=this;return(0,r.Jh)(this,function(s){switch(s.label){case 0:return[4,this.hasTable(this.getTypeormMetadataTableName())];case 1:if(!s.sent())return[2,Promise.resolve([])];return[4,this.query("SELECT * FROM current_schema()")];case 2:return n=s.sent()[0].current_schema,t=e.map(function(e){var t=(0,r.CR)(e.split("."),2),a=t[0],s=t[1];return s||(s=a,a=i.driver.options.schema||n),'("t"."schema" = \''+a+'\' AND "t"."name" = \''+s+"')"}).join(" OR "),a='SELECT "t".*, "v"."check_option" FROM '+this.escapePath(this.getTypeormMetadataTableName())+' "t" INNER JOIN "information_schema"."views" "v" ON "v"."table_schema" = "t"."schema" AND "v"."table_name" = "t"."name" WHERE "t"."type" = \'VIEW\' '+(t?"AND ("+t+")":""),[4,this.query(a)];case 3:return[2,s.sent().map(function(e){var t=new f.G,r=e.schema!==n||i.driver.options.schema?e.schema:void 0;return t.name=i.driver.buildTableName(e.name,r),t.expression=e.value,t})]}})})},n.prototype.loadTables=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,a,i,s,o,c,f,T,N,y,R,C,v,b,S=this;return(0,r.Jh)(this,function(L){switch(L.label){case 0:if(!e||!e.length)return[2,[]];return[4,this.query("SELECT * FROM current_schema()")];case 1:return n=L.sent()[0].current_schema,a='SELECT * FROM "information_schema"."tables" WHERE '+(t=e.map(function(e){var t=(0,r.CR)(e.split("."),2),a=t[0],i=t[1];return i||(i=a,a=S.driver.options.schema||n),'("table_schema" = \''+a+"' AND \"table_name\" = '"+i+"')"}).join(" OR ")),i='\n            SELECT columns.*,\n              pg_catalog.col_description((\'"\' || table_catalog || \'"."\' || table_schema || \'"."\' || table_name || \'"\')::regclass::oid, ordinal_position) AS description,\n              (\'"\' || "udt_schema" || \'"."\' || "udt_name" || \'"\')::"regtype" AS "regtype",\n              pg_catalog.format_type("col_attr"."atttypid", "col_attr"."atttypmod") AS "format_type"\n              FROM "information_schema"."columns"\n              LEFT JOIN "pg_catalog"."pg_attribute" AS "col_attr"\n              ON "col_attr"."attname" = "columns"."column_name"\n              AND "col_attr"."attrelid" = (\n                SELECT\n                  "cls"."oid" FROM "pg_catalog"."pg_class" AS "cls"\n                  LEFT JOIN "pg_catalog"."pg_namespace" AS "ns"\n                  ON "ns"."oid" = "cls"."relnamespace"\n                WHERE "cls"."relname" = "columns"."table_name"\n                AND "ns"."nspname" = "columns"."table_schema"\n              )\n            WHERE\n            '+t,o='SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "cnst"."conname" AS "constraint_name", pg_get_constraintdef("cnst"."oid") AS "expression", CASE "cnst"."contype" WHEN \'p\' THEN \'PRIMARY\' WHEN \'u\' THEN \'UNIQUE\' WHEN \'c\' THEN \'CHECK\' WHEN \'x\' THEN \'EXCLUDE\' END AS "constraint_type", "a"."attname" AS "column_name" FROM "pg_constraint" "cnst" INNER JOIN "pg_class" "t" ON "t"."oid" = "cnst"."conrelid" INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "cnst"."connamespace" LEFT JOIN "pg_attribute" "a" ON "a"."attrelid" = "cnst"."conrelid" AND "a"."attnum" = ANY ("cnst"."conkey") WHERE "t"."relkind" IN (\'r\', \'p\') AND ('+(s=e.map(function(e){var t=(0,r.CR)(e.split("."),2),a=t[0],i=t[1];return i||(i=a,a=S.driver.options.schema||n),'("ns"."nspname" = \''+a+'\' AND "t"."relname" = \''+i+"')"}).join(" OR "))+")",c='SELECT "ns"."nspname" AS "table_schema", "t"."relname" AS "table_name", "i"."relname" AS "constraint_name", "a"."attname" AS "column_name", CASE "ix"."indisunique" WHEN \'t\' THEN \'TRUE\' ELSE\'FALSE\' END AS "is_unique", pg_get_expr("ix"."indpred", "ix"."indrelid") AS "condition", "types"."typname" AS "type_name" FROM "pg_class" "t" INNER JOIN "pg_index" "ix" ON "ix"."indrelid" = "t"."oid" INNER JOIN "pg_attribute" "a" ON "a"."attrelid" = "t"."oid"  AND "a"."attnum" = ANY ("ix"."indkey") INNER JOIN "pg_namespace" "ns" ON "ns"."oid" = "t"."relnamespace" INNER JOIN "pg_class" "i" ON "i"."oid" = "ix"."indexrelid" INNER JOIN "pg_type" "types" ON "types"."oid" = "a"."atttypid" LEFT JOIN "pg_constraint" "cnst" ON "cnst"."conname" = "i"."relname" WHERE "t"."relkind" IN (\'r\', \'p\') AND "cnst"."contype" IS NULL AND ('+s+")",f=e.map(function(e){var t=(0,r.CR)(e.split("."),2),a=t[0],i=t[1];return i||(i=a,a=S.driver.options.schema||n),'("ns"."nspname" = \''+a+'\' AND "cl"."relname" = \''+i+"')"}).join(" OR "),[4,this.hasSupportForPartitionedTables()];case 2:return T='SELECT "con"."conname" AS "constraint_name", "con"."nspname" AS "table_schema", "con"."relname" AS "table_name", "att2"."attname" AS "column_name", "ns"."nspname" AS "referenced_table_schema", "cl"."relname" AS "referenced_table_name", "att"."attname" AS "referenced_column_name", "con"."confdeltype" AS "on_delete", "con"."confupdtype" AS "on_update", "con"."condeferrable" AS "deferrable", "con"."condeferred" AS "deferred" FROM ( SELECT UNNEST ("con1"."conkey") AS "parent", UNNEST ("con1"."confkey") AS "child", "con1"."confrelid", "con1"."conrelid", "con1"."conname", "con1"."contype", "ns"."nspname", "cl"."relname", "con1"."condeferrable", CASE WHEN "con1"."condeferred" THEN \'INITIALLY DEFERRED\' ELSE \'INITIALLY IMMEDIATE\' END as condeferred, CASE "con1"."confdeltype" WHEN \'a\' THEN \'NO ACTION\' WHEN \'r\' THEN \'RESTRICT\' WHEN \'c\' THEN \'CASCADE\' WHEN \'n\' THEN \'SET NULL\' WHEN \'d\' THEN \'SET DEFAULT\' END as "confdeltype", CASE "con1"."confupdtype" WHEN \'a\' THEN \'NO ACTION\' WHEN \'r\' THEN \'RESTRICT\' WHEN \'c\' THEN \'CASCADE\' WHEN \'n\' THEN \'SET NULL\' WHEN \'d\' THEN \'SET DEFAULT\' END as "confupdtype" FROM "pg_class" "cl" INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_constraint" "con1" ON "con1"."conrelid" = "cl"."oid" WHERE "con1"."contype" = \'f\' AND ('+f+') ) "con" INNER JOIN "pg_attribute" "att" ON "att"."attrelid" = "con"."confrelid" AND "att"."attnum" = "con"."child" INNER JOIN "pg_class" "cl" ON "cl"."oid" = "con"."confrelid" '+(L.sent()?' AND "cl"."relispartition" = \'f\'':"")+'INNER JOIN "pg_namespace" "ns" ON "cl"."relnamespace" = "ns"."oid" INNER JOIN "pg_attribute" "att2" ON "att2"."attrelid" = "con"."conrelid" AND "att2"."attnum" = "con"."parent"',[4,Promise.all([this.query(a),this.query(i),this.query(o),this.query(c),this.query(T)])];case 3:if(y=(N=r.CR.apply(void 0,[L.sent(),5]))[0],R=N[1],C=N[2],v=N[3],b=N[4],!y.length)return[2,[]];return[2,Promise.all(y.map(function(e){return(0,r.mG)(S,void 0,void 0,function(){var a,i,s,o,c,f,T,N,y,S,L=this;return(0,r.Jh)(this,function(O){switch(O.label){case 0:return a=new u.i,s=(i=function(e,t){return e[t]!==n||L.driver.options.schema?e[t]:void 0})(e,"table_schema"),a.name=this.driver.buildTableName(e.table_name,s),o=this.driver.buildTableName(e.table_name,e.table_schema),c=a,[4,Promise.all(R.filter(function(e){return L.driver.buildTableName(e.table_name,e.table_schema)===o}).map(function(i){return(0,r.mG)(L,void 0,void 0,function(){var s,c,u,m,h,p,E,d,f,T,A,N=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(s=C.filter(function(e){return N.driver.buildTableName(e.table_name,e.table_schema)===o&&e.column_name===i.column_name}),(c=new l.D).name=i.column_name,c.type=i.regtype.toLowerCase(),"numeric"!==c.type&&"decimal"!==c.type&&"float"!==c.type||(null===i.numeric_precision||this.isDefaultColumnPrecision(a,c,i.numeric_precision)?null===i.numeric_scale||this.isDefaultColumnScale(a,c,i.numeric_scale)||(c.precision=void 0):c.precision=i.numeric_precision,null===i.numeric_scale||this.isDefaultColumnScale(a,c,i.numeric_scale)?null===i.numeric_precision||this.isDefaultColumnPrecision(a,c,i.numeric_precision)||(c.scale=void 0):c.scale=i.numeric_scale),"array"===i.data_type.toLowerCase()&&(c.isArray=!0,u=c.type.replace("[]",""),c.type=this.connection.driver.normalizeType({type:u})),("interval"===c.type||"time without time zone"===c.type||"time with time zone"===c.type||"timestamp without time zone"===c.type||"timestamp with time zone"===c.type)&&(c.precision=this.isDefaultColumnPrecision(a,c,i.datetime_precision)?void 0:i.datetime_precision),!(-1!==c.type.indexOf("enum")))return[3,2];return c.type="enum",m='SELECT "e"."enumlabel" AS "value" FROM "pg_enum" "e" INNER JOIN "pg_type" "t" ON "t"."oid" = "e"."enumtypid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = \''+e.table_schema+'\' AND "t"."typname" = \''+this.buildEnumName(a,c.name,!1,!0)+"'",[4,this.query(m)];case 1:h=r.sent(),c.enum=h.map(function(e){return e.value}),r.label=2;case 2:if("geometry"!==c.type)return[3,4];return p='SELECT * FROM (\n                        SELECT\n                          "f_table_schema" "table_schema",\n                          "f_table_name" "table_name",\n                          "f_geometry_column" "column_name",\n                          "srid",\n                          "type"\n                        FROM "geometry_columns"\n                      ) AS _\n                      WHERE ('+t+') AND "column_name" = \''+c.name+"' AND \"table_name\" = '"+e.table_name+"'",[4,this.query(p)];case 3:h=r.sent(),c.spatialFeatureType=h[0].type,c.srid=h[0].srid,r.label=4;case 4:if("geography"!==c.type)return[3,6];return E='SELECT * FROM (\n                        SELECT\n                          "f_table_schema" "table_schema",\n                          "f_table_name" "table_name",\n                          "f_geography_column" "column_name",\n                          "srid",\n                          "type"\n                        FROM "geography_columns"\n                      ) AS _\n                      WHERE ('+t+') AND "column_name" = \''+c.name+"' AND \"table_name\" = '"+e.table_name+"'",[4,this.query(E)];case 5:h=r.sent(),c.spatialFeatureType=h[0].type,c.srid=h[0].srid,r.label=6;case 6:return -1!==this.driver.withLengthColumnTypes.indexOf(c.type)&&(c.isArray?d=(f=/\((\d+)\)/.exec(i.format_type))?f[1]:void 0:i.character_maximum_length&&(d=i.character_maximum_length.toString()),d&&(c.length=this.isDefaultColumnLength(a,c,d)?"":d)),c.isNullable="YES"===i.is_nullable,c.isPrimary=!!s.find(function(e){return"PRIMARY"===e.constraint_type}),A=!!(T=s.find(function(e){return"UNIQUE"===e.constraint_type}))&&!!C.find(function(e){return"UNIQUE"===e.constraint_type&&e.constraint_name===T.constraint_name&&e.column_name!==i.column_name}),c.isUnique=!!T&&!A,null!==i.column_default&&void 0!==i.column_default&&(i.column_default.replace(/"/gi,"")==="nextval('"+this.buildSequenceName(a,i.column_name,n,!0)+"'::regclass)"?(c.isGenerated=!0,c.generationStrategy="increment"):"gen_random_uuid()"===i.column_default||/^uuid_generate_v\d\(\)/.test(i.column_default)?(c.isGenerated=!0,c.generationStrategy="uuid"):(c.default=i.column_default.replace(/::.*/,""),c.default=c.default.replace(/^(-?\d+)$/,"'$1'"))),c.comment=null==i.description?void 0:i.description,i.character_set_name&&(c.charset=i.character_set_name),i.collation_name&&(c.collation=i.collation_name),[2,c]}})})}))];case 1:return c.columns=O.sent(),f=A.s.uniq(C.filter(function(e){return L.driver.buildTableName(e.table_name,e.table_schema)===o&&"UNIQUE"===e.constraint_type}),function(e){return e.constraint_name}),a.uniques=f.map(function(e){var n=C.filter(function(n){return n.constraint_name===e.constraint_name});return new d.v({name:e.constraint_name,columnNames:n.map(function(e){return e.column_name})})}),T=A.s.uniq(C.filter(function(e){return L.driver.buildTableName(e.table_name,e.table_schema)===o&&"CHECK"===e.constraint_type}),function(e){return e.constraint_name}),a.checks=T.map(function(e){var n=C.filter(function(n){return n.constraint_name===e.constraint_name});return new m.r({name:e.constraint_name,columnNames:n.map(function(e){return e.column_name}),expression:e.expression.replace(/^\s*CHECK\s*\((.*)\)\s*$/i,"$1")})}),N=A.s.uniq(C.filter(function(e){return L.driver.buildTableName(e.table_name,e.table_schema)===o&&"EXCLUDE"===e.constraint_type}),function(e){return e.constraint_name}),a.exclusions=N.map(function(e){return new h.N({name:e.constraint_name,expression:e.expression.substring(8)})}),y=A.s.uniq(b.filter(function(e){return L.driver.buildTableName(e.table_name,e.table_schema)===o}),function(e){return e.constraint_name}),a.foreignKeys=y.map(function(e){var n=b.filter(function(n){return n.constraint_name===e.constraint_name}),t=i(e,"referenced_table_schema"),r=L.driver.buildTableName(e.referenced_table_name,t);return new p.U({name:e.constraint_name,columnNames:n.map(function(e){return e.column_name}),referencedTableName:r,referencedColumnNames:n.map(function(e){return e.referenced_column_name}),onDelete:e.on_delete,onUpdate:e.on_update,deferrable:e.deferrable?e.deferred:void 0})}),S=A.s.uniq(v.filter(function(e){return L.driver.buildTableName(e.table_name,e.table_schema)===o}),function(e){return e.constraint_name}),a.indices=S.map(function(e){var n=v.filter(function(n){return n.table_schema===e.table_schema&&n.table_name===e.table_name&&n.constraint_name===e.constraint_name});return new E.s({table:a,name:e.constraint_name,columnNames:n.map(function(e){return e.column_name}),isUnique:"TRUE"===e.is_unique,where:e.condition,isSpatial:n.every(function(e){return L.driver.spatialTypes.indexOf(e.type_name)>=0}),isFulltext:!1})}),[2,a]}})})}))]}})})},n.prototype.createTableSql=function(e,n){var t=this,r=e.columns.map(function(n){return t.buildCreateColumnSql(e,n)}).join(", "),a="CREATE TABLE "+this.escapePath(e)+" ("+r;e.columns.filter(function(e){return e.isUnique}).forEach(function(n){e.uniques.some(function(e){return 1===e.columnNames.length&&e.columnNames[0]===n.name})||e.uniques.push(new d.v({name:t.connection.namingStrategy.uniqueConstraintName(e.name,[n.name]),columnNames:[n.name]}))}),e.uniques.length>0&&(a+=", "+e.uniques.map(function(n){return'CONSTRAINT "'+(n.name?n.name:t.connection.namingStrategy.uniqueConstraintName(e.name,n.columnNames))+'" UNIQUE ('+n.columnNames.map(function(e){return'"'+e+'"'}).join(", ")+")"}).join(", ")),e.checks.length>0&&(a+=", "+e.checks.map(function(n){return'CONSTRAINT "'+(n.name?n.name:t.connection.namingStrategy.checkConstraintName(e.name,n.expression))+'" CHECK ('+n.expression+")"}).join(", ")),e.exclusions.length>0&&(a+=", "+e.exclusions.map(function(n){return'CONSTRAINT "'+(n.name?n.name:t.connection.namingStrategy.exclusionConstraintName(e.name,n.expression))+'" EXCLUDE '+n.expression}).join(", ")),e.foreignKeys.length>0&&n&&(a+=", "+e.foreignKeys.map(function(n){var r=n.columnNames.map(function(e){return'"'+e+'"'}).join(", ");n.name||(n.name=t.connection.namingStrategy.foreignKeyName(e.name,n.columnNames,n.referencedTableName,n.referencedColumnNames));var a=n.referencedColumnNames.map(function(e){return'"'+e+'"'}).join(", "),i='CONSTRAINT "'+n.name+'" FOREIGN KEY ('+r+") REFERENCES "+t.escapePath(n.referencedTableName)+" ("+a+")";return n.onDelete&&(i+=" ON DELETE "+n.onDelete),n.onUpdate&&(i+=" ON UPDATE "+n.onUpdate),n.deferrable&&(i+=" DEFERRABLE "+n.deferrable),i}).join(", "));var i=e.columns.filter(function(e){return e.isPrimary});return i.length>0&&(a+=', CONSTRAINT "'+this.connection.namingStrategy.primaryKeyName(e.name,i.map(function(e){return e.name}))+'" PRIMARY KEY ('+i.map(function(e){return'"'+e.name+'"'}).join(", ")+")"),a+=")",e.columns.filter(function(e){return e.comment}).forEach(function(n){return a+="; COMMENT ON COLUMN "+t.escapePath(e)+'."'+n.name+'" IS '+t.escapeComment(n.comment)}),new N.A(a)},n.prototype.dropTableSql=function(e){return new N.A("DROP TABLE "+this.escapePath(e))},n.prototype.createViewSql=function(e){var n=e.materialized?"MATERIALIZED ":"",t=this.escapePath(e);return new N.A("string"==typeof e.expression?"CREATE "+n+"VIEW "+t+" AS "+e.expression:"CREATE "+n+"VIEW "+t+" AS "+e.expression(this.connection).getQuery())},n.prototype.insertViewDefinitionSql=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,a,i,s,o,c,u;return(0,r.Jh)(this,function(m){switch(m.label){case 0:return[4,this.query("SELECT * FROM current_schema()")];case 1:return n=m.sent()[0].current_schema,t=e.name.split("."),a=this.driver.options.schema||n,i=e.name,2===t.length&&(a=t[0],i=t[1]),s="string"==typeof e.expression?e.expression.trim():e.expression(this.connection).getQuery(),c=(o=(0,r.CR)(this.connection.createQueryBuilder().insert().into(this.getTypeormMetadataTableName()).values({type:"VIEW",schema:a,name:i,value:s}).getQueryAndParameters(),2))[0],u=o[1],[2,new N.A(c,u)]}})})},n.prototype.dropViewSql=function(e){return new N.A("DROP VIEW "+this.escapePath(e))},n.prototype.deleteViewDefinitionSql=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,a,i,s,o,c,u,m;return(0,r.Jh)(this,function(l){switch(l.label){case 0:return[4,this.query("SELECT * FROM current_schema()")];case 1:return n=l.sent()[0].current_schema,a=(t=e instanceof f.G?e.name:e).split("."),i=this.driver.options.schema||n,s=t,2===a.length&&(i=a[0],s=a[1]),o=this.connection.createQueryBuilder(),u=(c=(0,r.CR)(o.delete().from(this.getTypeormMetadataTableName()).where(o.escape("type")+" = 'VIEW'").andWhere(o.escape("schema")+" = :schema",{schema:i}).andWhere(o.escape("name")+" = :name",{name:s}).getQueryAndParameters(),2))[0],m=c[1],[2,new N.A(u,m)]}})})},n.prototype.extractSchema=function(e){var n=e instanceof u.i?e.name:e;return -1===n.indexOf(".")?this.driver.options.schema:n.split(".")[0]},n.prototype.dropEnumTypes=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return n='SELECT \'DROP TYPE IF EXISTS "\' || n.nspname || \'"."\' || t.typname || \'" CASCADE;\' as "query" FROM "pg_type" "t" INNER JOIN "pg_enum" "e" ON "e"."enumtypid" = "t"."oid" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" IN ('+e+') GROUP BY "n"."nspname", "t"."typname"',[4,this.query(n)];case 1:return[4,Promise.all(r.sent().map(function(e){return t.query(e.query)}))];case 2:return r.sent(),[2]}})})},n.prototype.hasEnumType=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return t='SELECT "n"."nspname", "t"."typname" FROM "pg_type" "t" INNER JOIN "pg_namespace" "n" ON "n"."oid" = "t"."typnamespace" WHERE "n"."nspname" = '+this.parseTableName(e).schema+' AND "t"."typname" = \''+this.buildEnumName(e,n,!1,!0)+"'",[4,this.query(t)];case 1:return[2,!!r.sent().length]}})})},n.prototype.createEnumTypeSql=function(e,n,t){t||(t=this.buildEnumName(e,n));var r=n.enum.map(function(e){return"'"+e.replace("'","''")+"'"}).join(", ");return new N.A("CREATE TYPE "+t+" AS ENUM("+r+")")},n.prototype.dropEnumTypeSql=function(e,n,t){return t||(t=this.buildEnumName(e,n)),new N.A("DROP TYPE "+t)},n.prototype.createIndexSql=function(e,n){var t=n.columnNames.map(function(e){return'"'+e+'"'}).join(", ");return new N.A("CREATE "+(n.isUnique?"UNIQUE ":"")+'INDEX "'+n.name+'" ON '+this.escapePath(e)+" "+(n.isSpatial?"USING GiST ":"")+"("+t+") "+(n.where?"WHERE "+n.where:""))},n.prototype.dropIndexSql=function(e,n){var t=n instanceof E.s?n.name:n,r=this.extractSchema(e);return new N.A(r?'DROP INDEX "'+r+'"."'+t+'"':'DROP INDEX "'+t+'"')},n.prototype.createPrimaryKeySql=function(e,n){var t=this.connection.namingStrategy.primaryKeyName(e.name,n),r=n.map(function(e){return'"'+e+'"'}).join(", ");return new N.A("ALTER TABLE "+this.escapePath(e)+' ADD CONSTRAINT "'+t+'" PRIMARY KEY ('+r+")")},n.prototype.dropPrimaryKeySql=function(e){var n=e.primaryColumns.map(function(e){return e.name}),t=this.connection.namingStrategy.primaryKeyName(e.name,n);return new N.A("ALTER TABLE "+this.escapePath(e)+' DROP CONSTRAINT "'+t+'"')},n.prototype.createUniqueConstraintSql=function(e,n){var t=n.columnNames.map(function(e){return'"'+e+'"'}).join(", ");return new N.A("ALTER TABLE "+this.escapePath(e)+' ADD CONSTRAINT "'+n.name+'" UNIQUE ('+t+")")},n.prototype.dropUniqueConstraintSql=function(e,n){var t=n instanceof d.v?n.name:n;return new N.A("ALTER TABLE "+this.escapePath(e)+' DROP CONSTRAINT "'+t+'"')},n.prototype.createCheckConstraintSql=function(e,n){return new N.A("ALTER TABLE "+this.escapePath(e)+' ADD CONSTRAINT "'+n.name+'" CHECK ('+n.expression+")")},n.prototype.dropCheckConstraintSql=function(e,n){var t=n instanceof m.r?n.name:n;return new N.A("ALTER TABLE "+this.escapePath(e)+' DROP CONSTRAINT "'+t+'"')},n.prototype.createExclusionConstraintSql=function(e,n){return new N.A("ALTER TABLE "+this.escapePath(e)+' ADD CONSTRAINT "'+n.name+'" EXCLUDE '+n.expression)},n.prototype.dropExclusionConstraintSql=function(e,n){var t=n instanceof h.N?n.name:n;return new N.A("ALTER TABLE "+this.escapePath(e)+' DROP CONSTRAINT "'+t+'"')},n.prototype.createForeignKeySql=function(e,n){var t=n.columnNames.map(function(e){return'"'+e+'"'}).join(", "),r=n.referencedColumnNames.map(function(e){return'"'+e+'"'}).join(","),a="ALTER TABLE "+this.escapePath(e)+' ADD CONSTRAINT "'+n.name+'" FOREIGN KEY ('+t+") "+("REFERENCES "+this.escapePath(n.referencedTableName))+"("+r+")";return n.onDelete&&(a+=" ON DELETE "+n.onDelete),n.onUpdate&&(a+=" ON UPDATE "+n.onUpdate),n.deferrable&&(a+=" DEFERRABLE "+n.deferrable),new N.A(a)},n.prototype.dropForeignKeySql=function(e,n){var t=n instanceof p.U?n.name:n;return new N.A("ALTER TABLE "+this.escapePath(e)+' DROP CONSTRAINT "'+t+'"')},n.prototype.buildSequenceName=function(e,n,t,r,a){var i=n instanceof l.D?n.name:n,s=void 0,o=void 0;-1===e.name.indexOf(".")?o=e.name:(s=e.name.split(".")[0],o=e.name.split(".")[1]);var c=o+"_"+i+"_seq";return(c.length>this.connection.driver.maxAliasLength&&(c=o.substring(0,29)+"_"+i.substring(0,Math.max(29,63-o.length-5))+"_seq"),s&&s!==t&&!a)?r?s+"."+c:'"'+s+'"."'+c+'"':r?""+c:'"'+c+'"'},n.prototype.buildEnumName=function(e,n,t,r,a){if(void 0===t&&(t=!0),n instanceof l.D&&n.enumName){var i=n.enumName;return a&&(i+="_old"),r?i:'"'+i+'"'}var s=n instanceof l.D?n.name:n,o=-1===e.name.indexOf(".")?this.driver.options.schema:e.name.split(".")[0],c=-1===e.name.indexOf(".")?e.name:e.name.split(".")[1],u=o&&t?o+"."+c+"_"+s.toLowerCase()+"_enum":c+"_"+s.toLowerCase()+"_enum";return a&&(u+="_old"),u.split(".").map(function(e){return r?e:'"'+e+'"'}).join(".")},n.prototype.getEnumTypeName=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,a,i,s,o;return(0,r.Jh)(this,function(c){switch(c.label){case 0:return[4,this.query("SELECT * FROM current_schema()")];case 1:return t=c.sent()[0].current_schema,i=(a=(0,r.CR)(e.name.split("."),2))[0],(s=a[1])||(s=i,i=this.driver.options.schema||t),[4,this.query('SELECT "udt_schema", "udt_name" '+('FROM "information_schema"."columns" WHERE "table_schema" = \''+i+"' AND \"table_name\" = '"+s)+"' AND \"column_name\"='"+n.name+"'")];case 2:return[2,{enumTypeSchema:(o=c.sent())[0].udt_schema,enumTypeName:o[0].udt_name}]}})})},n.prototype.escapeComment=function(e){return void 0===e||0===e.length?"NULL":"'"+(e=e.replace("'","''").replace("\x00",""))+"'"},n.prototype.escapePath=function(e,n){var t=e instanceof u.i||e instanceof f.G?e.name:e;return(t=-1===t.indexOf(".")&&this.driver.options.schema?this.driver.options.schema+"."+t:t).split(".").map(function(e){return n?e:'"'+e+'"'}).join(".")},n.prototype.parseTableName=function(e){var n=e instanceof u.i?e.name:e;return -1===n.indexOf(".")?{schema:this.driver.options.schema?"'"+this.driver.options.schema+"'":"current_schema()",tableName:"'"+n+"'"}:{schema:"'"+n.split(".")[0]+"'",tableName:"'"+n.split(".")[1]+"'"}},n.prototype.buildCreateColumnSql=function(e,n){var t='"'+n.name+'"';return!0===n.isGenerated&&"uuid"!==n.generationStrategy&&(("integer"===n.type||"int"===n.type||"int4"===n.type)&&(t+=" SERIAL"),("smallint"===n.type||"int2"===n.type)&&(t+=" SMALLSERIAL"),("bigint"===n.type||"int8"===n.type)&&(t+=" BIGSERIAL")),"enum"===n.type||"simple-enum"===n.type?(t+=" "+this.buildEnumName(e,n),n.isArray&&(t+=" array")):n.isGenerated&&"uuid"!==n.type||(t+=" "+this.connection.driver.createFullType(n)),n.charset&&(t+=' CHARACTER SET "'+n.charset+'"'),n.collation&&(t+=' COLLATE "'+n.collation+'"'),!0!==n.isNullable&&(t+=" NOT NULL"),void 0!==n.default&&null!==n.default&&(t+=" DEFAULT "+n.default),n.isGenerated&&"uuid"===n.generationStrategy&&!n.default&&(t+=" DEFAULT "+this.driver.uuidGenerator),t},n.prototype.hasSupportForPartitionedTables=function(){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){switch(e.label){case 0:return[4,this.query("SELECT TRUE FROM information_schema.columns WHERE table_name = 'pg_class' and column_name = 'relispartition'")];case 1:return[2,!!e.sent().length]}})})},n}(c.Y)}}]);