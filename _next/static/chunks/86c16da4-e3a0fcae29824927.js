"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[292],{31:function(e,n,t){t.d(n,{Y:function(){return v}});var r=t(274),i=t(7316),a=t(5128),s=t(8956),o=t(6556),u=t(3003),c=t(5838),h=t(879),m=t(124),l=t(9396),A=t(9652),p=t(1959),E=t(2611),f=t(4894),d=t(5738),T=t(3298),N=t(9522),C=t(1444),v=function(e){function n(n,t){var r=e.call(this)||this;return r.queryResponsibilityChain=[],r.driver=n,r.connection=n.connection,r.broadcaster=new f.a(r),r.mode=t,r}return(0,r.ZT)(n,e),n.prototype.connect=function(){return Promise.resolve()},n.prototype.release=function(){return this.isReleased=!0,Promise.resolve()},n.prototype.startTransaction=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t=this;return(0,r.Jh)(this,function(i){switch(i.label){case 0:if(this.isReleased)throw new a.Y;if(this.isTransactionActive)throw new s.S;if(n=new C.D,this.broadcaster.broadcastBeforeTransactionStartEvent(n),!(n.promises.length>0))return[3,2];return[4,Promise.all(n.promises)];case 1:i.sent(),i.label=2;case 2:return[2,new Promise(function(n,i){return(0,r.mG)(t,void 0,void 0,function(){var t,a,s,o=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return this.isTransactionActive=!0,[4,"slave"===this.mode?this.driver.obtainSlaveConnection():this.driver.obtainMasterConnection()];case 1:if(t=r.sent(),this.databaseConnection=t.transaction(),a=function(t){if(t)return o.isTransactionActive=!1,i(t);n(),o.connection.logger.logQuery("BEGIN TRANSACTION"),e&&o.connection.logger.logQuery("SET TRANSACTION ISOLATION LEVEL "+e)},e?this.databaseConnection.begin(this.convertIsolationLevel(e),a):this.databaseConnection.begin(a),s=new C.D,this.broadcaster.broadcastAfterTransactionStartEvent(s),!(s.promises.length>0))return[3,3];return[4,Promise.all(s.promises)];case 2:r.sent(),r.label=3;case 3:return[2]}})})})]}})})},n.prototype.commitTransaction=function(){return(0,r.mG)(this,void 0,void 0,function(){var e,n=this;return(0,r.Jh)(this,function(t){switch(t.label){case 0:if(this.isReleased)throw new a.Y;if(!this.isTransactionActive)throw new o.W;if(e=new C.D,this.broadcaster.broadcastBeforeTransactionCommitEvent(e),!(e.promises.length>0))return[3,2];return[4,Promise.all(e.promises)];case 1:t.sent(),t.label=2;case 2:return[2,new Promise(function(e,t){n.databaseConnection.commit(function(i){return(0,r.mG)(n,void 0,void 0,function(){var n;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(i)return[2,t(i)];if(this.isTransactionActive=!1,this.databaseConnection=null,n=new C.D,this.broadcaster.broadcastAfterTransactionCommitEvent(n),!(n.promises.length>0))return[3,2];return[4,Promise.all(n.promises)];case 1:r.sent(),r.label=2;case 2:return e(),this.connection.logger.logQuery("COMMIT"),[2]}})})})})]}})})},n.prototype.rollbackTransaction=function(){return(0,r.mG)(this,void 0,void 0,function(){var e,n=this;return(0,r.Jh)(this,function(t){switch(t.label){case 0:if(this.isReleased)throw new a.Y;if(!this.isTransactionActive)throw new o.W;if(e=new C.D,this.broadcaster.broadcastBeforeTransactionRollbackEvent(e),!(e.promises.length>0))return[3,2];return[4,Promise.all(e.promises)];case 1:t.sent(),t.label=2;case 2:return[2,new Promise(function(e,t){n.databaseConnection.rollback(function(i){return(0,r.mG)(n,void 0,void 0,function(){var n;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(i)return[2,t(i)];if(this.isTransactionActive=!1,this.databaseConnection=null,n=new C.D,this.broadcaster.broadcastAfterTransactionRollbackEvent(n),!(n.promises.length>0))return[3,2];return[4,Promise.all(n.promises)];case 1:r.sent(),r.label=2;case 2:return e(),this.connection.logger.logQuery("ROLLBACK"),[2]}})})})})]}})})},n.prototype.query=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,s,o,u,c=this;return(0,r.Jh)(this,function(h){switch(h.label){case 0:if(this.isReleased)throw new a.Y;if(s=new Promise(function(e){return t=e}),!this.queryResponsibilityChain.length)return[3,2];return o=(0,r.fl)(this.queryResponsibilityChain),this.queryResponsibilityChain.push(s),[4,Promise.all(o)];case 1:h.sent(),h.label=2;case 2:return u=new Promise(function(a,o){return(0,r.mG)(c,void 0,void 0,function(){var c,h,m,l=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),this.driver.connection.logger.logQuery(e,n,this),[4,"slave"===this.mode?this.driver.obtainSlaveConnection():this.driver.obtainMasterConnection()];case 1:return c=r.sent(),h=new this.driver.mssql.Request(this.isTransactionActive?this.databaseConnection:c),n&&n.length&&n.forEach(function(e,n){if(e instanceof N.R){var t=l.mssqlParameterToNativeParameter(e);t?h.input(n,t,e.value):h.input(n,e.value)}else h.input(n,e)}),m=+new Date,h.query(e,function(r,c){var h=l.driver.connection.options.maxQueryExecutionTime,A=+new Date-m;h&&A>h&&l.driver.connection.logger.logQuerySlow(A,e,n,l);var p=function(){-1!==E&&l.queryResponsibilityChain.splice(E,1),-1!==f&&l.queryResponsibilityChain.splice(f,1),t()},E=l.queryResponsibilityChain.indexOf(u),f=l.queryResponsibilityChain.indexOf(s);if(r)return l.driver.connection.logger.logQueryError(r,e,n,l),p(),o(new i.O(e,n,r));"DELETE"===e.slice(0,e.indexOf(" "))?a([c.recordset,c.rowsAffected[0]]):a(c.recordset),p()}),[3,3];case 2:return o(r.sent()),[3,3];case 3:return[2]}})})}),this.queryResponsibilityChain.push(u),[2,u]}})})},n.prototype.stream=function(e,n,t,i){return(0,r.mG)(this,void 0,void 0,function(){var s,o,u,c,h=this;return(0,r.Jh)(this,function(m){switch(m.label){case 0:if(this.isReleased)throw new a.Y;if(o=new Promise(function(e){return s=e}),!this.queryResponsibilityChain.length)return[3,2];return u=(0,r.fl)(this.queryResponsibilityChain),this.queryResponsibilityChain.push(o),[4,Promise.all(u)];case 1:m.sent(),m.label=2;case 2:return c=new Promise(function(a,u){return(0,r.mG)(h,void 0,void 0,function(){var h,m,l=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return this.driver.connection.logger.logQuery(e,n,this),[4,"slave"===this.mode?this.driver.obtainSlaveConnection():this.driver.obtainMasterConnection()];case 1:return h=r.sent(),(m=new this.driver.mssql.Request(this.isTransactionActive?this.databaseConnection:h)).stream=!0,n&&n.length&&n.forEach(function(e,n){e instanceof N.R?m.input(n,l.mssqlParameterToNativeParameter(e),e.value):m.input(n,e)}),m.query(e,function(t,r){var i=function(){-1!==h&&l.queryResponsibilityChain.splice(h,1),-1!==m&&l.queryResponsibilityChain.splice(m,1),s()},h=l.queryResponsibilityChain.indexOf(c),m=l.queryResponsibilityChain.indexOf(o);if(t)return l.driver.connection.logger.logQueryError(t,e,n,l),i(),u(t);a(r.recordset),i()}),t&&m.on("done",t),i&&m.on("error",i),a(m),[2]}})})}),this.isTransactionActive&&this.queryResponsibilityChain.push(c),[2,c]}})})},n.prototype.getDatabases=function(){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){switch(e.label){case 0:return[4,this.query("EXEC sp_databases")];case 1:return[2,e.sent().map(function(e){return e.DATABASE_NAME})]}})})},n.prototype.getSchemas=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n;return(0,r.Jh)(this,function(t){switch(t.label){case 0:return n=e?'SELECT * FROM "'+e+'"."sys"."schema"':'SELECT * FROM "sys"."schemas"',[4,this.query(n)];case 1:return[2,t.sent().map(function(e){return e.name})]}})})},n.prototype.hasDatabase=function(e){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(n){switch(n.label){case 0:return[4,this.query("SELECT DB_ID('"+e+'\') as "db_id"')];case 1:return[2,!!n.sent()[0].db_id]}})})},n.prototype.hasSchema=function(e){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(n){switch(n.label){case 0:return[4,this.query("SELECT SCHEMA_ID('"+e+'\') as "schema_id"')];case 1:return[2,!!n.sent()[0].schema_id]}})})},n.prototype.hasTable=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,i;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return t="SCHEMA_NAME()"===(n=this.parseTableName(e)).schema?n.schema:"'"+n.schema+"'",i='SELECT * FROM "'+n.database+'"."INFORMATION_SCHEMA"."TABLES" WHERE "TABLE_NAME" = \''+n.name+'\' AND "TABLE_SCHEMA" = '+t,[4,this.query(i)];case 1:return[2,!!r.sent().length]}})})},n.prototype.hasColumn=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return i="SCHEMA_NAME()"===(t=this.parseTableName(e)).schema?t.schema:"'"+t.schema+"'",a='SELECT * FROM "'+t.database+'"."INFORMATION_SCHEMA"."COLUMNS" WHERE "TABLE_NAME" = \''+t.name+"' AND \"COLUMN_NAME\" = '"+n+'\' AND "TABLE_SCHEMA" = '+i,[4,this.query(a)];case 1:return[2,!!r.sent().length]}})})},n.prototype.createDatabase=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return t=n?"IF DB_ID('"+e+"') IS NULL CREATE DATABASE \""+e+'"':'CREATE DATABASE "'+e+'"',i='DROP DATABASE "'+e+'"',[4,this.executeQueries(new T.A(t),new T.A(i))];case 1:return r.sent(),[2]}})})},n.prototype.dropDatabase=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return t=n?"IF DB_ID('"+e+"') IS NOT NULL DROP DATABASE \""+e+'"':'DROP DATABASE "'+e+'"',i='CREATE DATABASE "'+e+'"',[4,this.executeQueries(new T.A(t),new T.A(i))];case 1:return r.sent(),[2]}})})},n.prototype.createSchema=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o,u;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(t=[],i=[],-1!==e.indexOf("."))return[3,1];return a=n?"IF SCHEMA_ID('"+e+"') IS NULL BEGIN EXEC ('CREATE SCHEMA \""+e+"\"') END":'CREATE SCHEMA "'+e+'"',t.push(new T.A(a)),i.push(new T.A('DROP SCHEMA "'+e+'"')),[3,3];case 1:return s=e.split(".")[0],o=e.split(".")[1],[4,this.getCurrentDatabase()];case 2:u=r.sent(),t.push(new T.A('USE "'+s+'"')),i.push(new T.A('USE "'+u+'"')),a=n?"IF SCHEMA_ID('"+o+"') IS NULL BEGIN EXEC ('CREATE SCHEMA \""+o+"\"') END":'CREATE SCHEMA "'+o+'"',t.push(new T.A(a)),i.push(new T.A('DROP SCHEMA "'+o+'"')),t.push(new T.A('USE "'+u+'"')),i.push(new T.A('USE "'+s+'"')),r.label=3;case 3:return[4,this.executeQueries(t,i)];case 4:return r.sent(),[2]}})})},n.prototype.dropSchema=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o,u;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(t=[],i=[],-1!==e.indexOf("."))return[3,1];return a=n?"IF SCHEMA_ID('"+e+"') IS NULL BEGIN EXEC ('DROP SCHEMA \""+e+"\"') END":'DROP SCHEMA "'+e+'"',t.push(new T.A(a)),i.push(new T.A('CREATE SCHEMA "'+e+'"')),[3,3];case 1:return s=e.split(".")[0],o=e.split(".")[1],[4,this.getCurrentDatabase()];case 2:u=r.sent(),t.push(new T.A('USE "'+s+'"')),i.push(new T.A('USE "'+u+'"')),a=n?"IF SCHEMA_ID('"+o+"') IS NULL BEGIN EXEC ('DROP SCHEMA \""+o+"\"') END":'DROP SCHEMA "'+o+'"',t.push(new T.A(a)),i.push(new T.A('CREATE SCHEMA "'+o+'"')),t.push(new T.A('USE "'+u+'"')),i.push(new T.A('USE "'+s+'"')),r.label=3;case 3:return[4,this.executeQueries(t,i)];case 4:return r.sent(),[2]}})})},n.prototype.createTable=function(e,n,t,i){return void 0===n&&(n=!1),void 0===t&&(t=!0),void 0===i&&(i=!0),(0,r.mG)(this,void 0,void 0,function(){var a,s,o=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!n)return[3,2];return[4,this.hasTable(e)];case 1:if(r.sent())return[2,Promise.resolve()];r.label=2;case 2:return s=[],(a=[]).push(this.createTableSql(e,t)),s.push(this.dropTableSql(e)),t&&e.foreignKeys.forEach(function(n){return s.push(o.dropForeignKeySql(e,n))}),i&&e.indices.forEach(function(n){n.name||(n.name=o.connection.namingStrategy.indexName(e.name,n.columnNames,n.where)),a.push(o.createIndexSql(e,n)),s.push(o.dropIndexSql(e,n))}),[4,this.executeQueries(a,s)];case 3:return r.sent(),[2]}})})},n.prototype.dropTable=function(e,n,t,i){return void 0===t&&(t=!0),void 0===i&&(i=!0),(0,r.mG)(this,void 0,void 0,function(){var a,s,o,u,h,m=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!n)return[3,2];return[4,this.hasTable(e)];case 1:if(!r.sent())return[2,Promise.resolve()];r.label=2;case 2:if(a=t,!(e instanceof c.i))return[3,3];return o=e,[3,5];case 3:return[4,this.getCachedTable(e)];case 4:o=r.sent(),r.label=5;case 5:return s=o,u=[],h=[],i&&s.indices.forEach(function(e){u.push(m.dropIndexSql(s,e)),h.push(m.createIndexSql(s,e))}),t&&s.foreignKeys.forEach(function(e){return u.push(m.dropForeignKeySql(s,e))}),u.push(this.dropTableSql(s)),h.push(this.createTableSql(s,a)),[4,this.executeQueries(u,h)];case 6:return r.sent(),[2]}})})},n.prototype.createView=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,i,a,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return t=[],(n=[]).push(this.createViewSql(e)),a=(i=n).push,[4,this.insertViewDefinitionSql(e)];case 1:return a.apply(i,[r.sent()]),t.push(this.dropViewSql(e)),o=(s=t).push,[4,this.deleteViewDefinitionSql(e)];case 2:return o.apply(s,[r.sent()]),[4,this.executeQueries(n,t)];case 3:return r.sent(),[2]}})})},n.prototype.dropView=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,i,a,s,o,u,c;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return n=e instanceof E.G?e.name:e,[4,this.getCachedView(n)];case 1:return t=r.sent(),a=[],o=(s=i=[]).push,[4,this.deleteViewDefinitionSql(t)];case 2:return o.apply(s,[r.sent()]),i.push(this.dropViewSql(t)),c=(u=a).push,[4,this.insertViewDefinitionSql(t)];case 3:return c.apply(u,[r.sent()]),a.push(this.createViewSql(t)),[4,this.executeQueries(i,a)];case 4:return r.sent(),[2]}})})},n.prototype.renameTable=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o,u,h,m,l,A,p,E,f,d=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(t=[],i=[],!(e instanceof c.i))return[3,1];return s=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:s=r.sent(),r.label=3;case 3:return o=(a=s).clone(),u=void 0,h=void 0,m=a.name,3===(l=a.name.split(".")).length?(u=l[0],m=l[2],""!==l[1]&&(h=l[1])):2===l.length&&(h=l[0],m=l[1]),o.name=this.driver.buildTableName(n,h,u),[4,this.getCurrentDatabase()];case 4:return A=r.sent(),u&&u!==A&&(t.push(new T.A('USE "'+u+'"')),i.push(new T.A('USE "'+A+'"'))),t.push(new T.A('EXEC sp_rename "'+this.escapePath(a,!0)+'", "'+n+'"')),i.push(new T.A('EXEC sp_rename "'+this.escapePath(o,!0)+'", "'+m+'"')),o.primaryColumns.length>0&&(p=o.primaryColumns.map(function(e){return e.name}),E=this.connection.namingStrategy.primaryKeyName(a,p),f=this.connection.namingStrategy.primaryKeyName(o,p),t.push(new T.A('EXEC sp_rename "'+this.escapePath(o,!0)+"."+E+'", "'+f+'"')),i.push(new T.A('EXEC sp_rename "'+this.escapePath(o,!0)+"."+f+'", "'+E+'"'))),o.uniques.forEach(function(e){var n=d.connection.namingStrategy.uniqueConstraintName(o,e.columnNames);t.push(new T.A('EXEC sp_rename "'+d.escapePath(o,!0)+"."+e.name+'", "'+n+'"')),i.push(new T.A('EXEC sp_rename "'+d.escapePath(o,!0)+"."+n+'", "'+e.name+'"')),e.name=n}),o.indices.forEach(function(e){var n=d.connection.namingStrategy.indexName(o,e.columnNames,e.where);t.push(new T.A('EXEC sp_rename "'+d.escapePath(o,!0)+"."+e.name+'", "'+n+'", "INDEX"')),i.push(new T.A('EXEC sp_rename "'+d.escapePath(o,!0)+"."+n+'", "'+e.name+'", "INDEX"')),e.name=n}),o.foreignKeys.forEach(function(e){var n=d.connection.namingStrategy.foreignKeyName(o,e.columnNames,e.referencedTableName,e.referencedColumnNames);t.push(new T.A('EXEC sp_rename "'+d.buildForeignKeyName(e.name,h,u)+'", "'+n+'"')),i.push(new T.A('EXEC sp_rename "'+d.buildForeignKeyName(n,h,u)+'", "'+e.name+'"')),e.name=n}),u&&u!==A&&(t.push(new T.A('USE "'+A+'"')),i.push(new T.A('USE "'+u+'"'))),[4,this.executeQueries(t,i)];case 5:return r.sent(),a.name=o.name,this.replaceCachedTable(a,o),[2]}})})},n.prototype.addColumn=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o,u,h,m,l,A,E,f,d;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:return a=(t=i).clone(),o=[],(s=[]).push(new T.A("ALTER TABLE "+this.escapePath(t)+" ADD "+this.buildCreateColumnSql(t,n,!1,!0))),o.push(new T.A("ALTER TABLE "+this.escapePath(t)+' DROP COLUMN "'+n.name+'"')),n.isPrimary&&((u=a.primaryColumns).length>0&&(h=this.connection.namingStrategy.primaryKeyName(a.name,u.map(function(e){return e.name})),m=u.map(function(e){return'"'+e.name+'"'}).join(", "),s.push(new T.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+h+'"')),o.push(new T.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+h+'" PRIMARY KEY ('+m+")"))),u.push(n),l=this.connection.namingStrategy.primaryKeyName(a.name,u.map(function(e){return e.name})),A=u.map(function(e){return'"'+e.name+'"'}).join(", "),s.push(new T.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+l+'" PRIMARY KEY ('+A+")")),o.push(new T.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+l+'"'))),(E=a.indices.find(function(e){return 1===e.columnNames.length&&e.columnNames[0]===n.name}))&&(s.push(this.createIndexSql(t,E)),o.push(this.dropIndexSql(t,E))),n.isUnique&&(f=new p.v({name:this.connection.namingStrategy.uniqueConstraintName(t.name,[n.name]),columnNames:[n.name]}),a.uniques.push(f),s.push(new T.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+f.name+'" UNIQUE ("'+n.name+'")')),o.push(new T.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+f.name+'"'))),null!==n.default&&void 0!==n.default&&(d=this.connection.namingStrategy.defaultConstraintName(t.name,n.name),o.push(new T.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+d+'"'))),[4,this.executeQueries(s,o)];case 4:return r.sent(),a.addColumn(n),this.replaceCachedTable(t,a),[2]}})})},n.prototype.addColumns=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o;return(0,r.Jh)(this,function(u){switch(u.label){case 0:u.trys.push([0,5,6,7]),i=(t=(0,r.XA)(n)).next(),u.label=1;case 1:if(i.done)return[3,4];return a=i.value,[4,this.addColumn(e,a)];case 2:u.sent(),u.label=3;case 3:return i=t.next(),[3,1];case 4:return[3,7];case 5:return s={error:u.sent()},[3,7];case 6:try{i&&!i.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}return[7];case 7:return[2]}})})},n.prototype.renameColumn=function(e,n,t){return(0,r.mG)(this,void 0,void 0,function(){var i,a,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:if(i=a,!(s=n instanceof m.D?n:i.columns.find(function(e){return e.name===n})))throw Error('Column "'+n+'" was not found in the "'+i.name+'" table.');return o=void 0,t instanceof m.D?o=t:(o=s.clone()).name=t,[4,this.changeColumn(i,s,o)];case 4:return r.sent(),[2]}})})},n.prototype.changeColumn=function(e,n,t){return(0,r.mG)(this,void 0,void 0,function(){var i,a,s,o,u,h,l,A,E,f,d,N,C,v,y,S,R,L,O,b,_,I=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return a=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:a=r.sent(),r.label=3;case 3:if(s=(i=a).clone(),o=[],u=[],!(h=n instanceof m.D?n:i.columns.find(function(e){return e.name===n})))throw Error('Column "'+n+'" was not found in the "'+i.name+'" table.');if(!(t.isGenerated!==h.isGenerated&&"uuid"!==t.generationStrategy||t.type!==h.type||t.length!==h.length))return[3,6];return[4,this.dropColumn(i,h)];case 4:return r.sent(),[4,this.addColumn(i,t)];case 5:return r.sent(),s=i.clone(),[3,10];case 6:if(!(t.name!==h.name))return[3,8];return l=void 0,A=void 0,3===(E=i.name.split(".")).length?(l=E[0],""!==E[1]&&(A=E[1])):2===E.length&&(A=E[0]),[4,this.getCurrentDatabase()];case 7:f=r.sent(),l&&l!==f&&(o.push(new T.A('USE "'+l+'"')),u.push(new T.A('USE "'+f+'"'))),o.push(new T.A('EXEC sp_rename "'+this.escapePath(i,!0)+"."+h.name+'", "'+t.name+'"')),u.push(new T.A('EXEC sp_rename "'+this.escapePath(i,!0)+"."+t.name+'", "'+h.name+'"')),!0===h.isPrimary&&(N=(d=s.primaryColumns).map(function(e){return e.name}),C=this.connection.namingStrategy.primaryKeyName(s,N),N.splice(N.indexOf(h.name),1),N.push(t.name),v=this.connection.namingStrategy.primaryKeyName(s,N),o.push(new T.A('EXEC sp_rename "'+this.escapePath(s,!0)+"."+C+'", "'+v+'"')),u.push(new T.A('EXEC sp_rename "'+this.escapePath(s,!0)+"."+v+'", "'+C+'"'))),s.findColumnIndices(h).forEach(function(e){e.columnNames.splice(e.columnNames.indexOf(h.name),1),e.columnNames.push(t.name);var n=I.connection.namingStrategy.indexName(s,e.columnNames,e.where);o.push(new T.A('EXEC sp_rename "'+I.escapePath(s,!0)+"."+e.name+'", "'+n+'", "INDEX"')),u.push(new T.A('EXEC sp_rename "'+I.escapePath(s,!0)+"."+n+'", "'+e.name+'", "INDEX"')),e.name=n}),s.findColumnForeignKeys(h).forEach(function(e){e.columnNames.splice(e.columnNames.indexOf(h.name),1),e.columnNames.push(t.name);var n=I.connection.namingStrategy.foreignKeyName(s,e.columnNames,e.referencedTableName,e.referencedColumnNames);o.push(new T.A('EXEC sp_rename "'+I.buildForeignKeyName(e.name,A,l)+'", "'+n+'"')),u.push(new T.A('EXEC sp_rename "'+I.buildForeignKeyName(n,A,l)+'", "'+e.name+'"')),e.name=n}),s.findColumnChecks(h).forEach(function(e){e.columnNames.splice(e.columnNames.indexOf(h.name),1),e.columnNames.push(t.name);var n=I.connection.namingStrategy.checkConstraintName(s,e.expression);o.push(new T.A('EXEC sp_rename "'+I.escapePath(s,!0)+"."+e.name+'", "'+n+'"')),u.push(new T.A('EXEC sp_rename "'+I.escapePath(s,!0)+"."+n+'", "'+e.name+'"')),e.name=n}),s.findColumnUniques(h).forEach(function(e){e.columnNames.splice(e.columnNames.indexOf(h.name),1),e.columnNames.push(t.name);var n=I.connection.namingStrategy.uniqueConstraintName(s,e.columnNames);o.push(new T.A('EXEC sp_rename "'+I.escapePath(s,!0)+"."+e.name+'", "'+n+'"')),u.push(new T.A('EXEC sp_rename "'+I.escapePath(s,!0)+"."+n+'", "'+e.name+'"')),e.name=n}),null!==h.default&&void 0!==h.default&&(y=this.connection.namingStrategy.defaultConstraintName(i.name,h.name),S=this.connection.namingStrategy.defaultConstraintName(i.name,t.name),o.push(new T.A("ALTER TABLE "+this.escapePath(i)+' DROP CONSTRAINT "'+y+'"')),u.push(new T.A("ALTER TABLE "+this.escapePath(i)+' ADD CONSTRAINT "'+y+'" DEFAULT '+h.default+' FOR "'+t.name+'"')),o.push(new T.A("ALTER TABLE "+this.escapePath(i)+' ADD CONSTRAINT "'+S+'" DEFAULT '+h.default+' FOR "'+t.name+'"')),u.push(new T.A("ALTER TABLE "+this.escapePath(i)+' DROP CONSTRAINT "'+S+'"'))),l&&l!==f&&(o.push(new T.A('USE "'+f+'"')),u.push(new T.A('USE "'+l+'"'))),R=s.columns.find(function(e){return e.name===h.name}),s.columns[s.columns.indexOf(R)].name=t.name,h.name=t.name,r.label=8;case 8:return this.isColumnChanged(h,t,!1)&&(o.push(new T.A("ALTER TABLE "+this.escapePath(i)+" ALTER COLUMN "+this.buildCreateColumnSql(i,t,!0,!1))),u.push(new T.A("ALTER TABLE "+this.escapePath(i)+" ALTER COLUMN "+this.buildCreateColumnSql(i,h,!0,!1)))),t.isPrimary!==h.isPrimary&&((d=s.primaryColumns).length>0&&(L=this.connection.namingStrategy.primaryKeyName(s.name,d.map(function(e){return e.name})),N=d.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new T.A("ALTER TABLE "+this.escapePath(i)+' DROP CONSTRAINT "'+L+'"')),u.push(new T.A("ALTER TABLE "+this.escapePath(i)+' ADD CONSTRAINT "'+L+'" PRIMARY KEY ('+N+")"))),!0===t.isPrimary?(d.push(t),s.columns.find(function(e){return e.name===t.name}).isPrimary=!0,L=this.connection.namingStrategy.primaryKeyName(s.name,d.map(function(e){return e.name})),N=d.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new T.A("ALTER TABLE "+this.escapePath(i)+' ADD CONSTRAINT "'+L+'" PRIMARY KEY ('+N+")")),u.push(new T.A("ALTER TABLE "+this.escapePath(i)+' DROP CONSTRAINT "'+L+'"'))):(O=d.find(function(e){return e.name===t.name}),d.splice(d.indexOf(O),1),s.columns.find(function(e){return e.name===t.name}).isPrimary=!1,d.length>0&&(L=this.connection.namingStrategy.primaryKeyName(s.name,d.map(function(e){return e.name})),N=d.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new T.A("ALTER TABLE "+this.escapePath(i)+' ADD CONSTRAINT "'+L+'" PRIMARY KEY ('+N+")")),u.push(new T.A("ALTER TABLE "+this.escapePath(i)+' DROP CONSTRAINT "'+L+'"'))))),t.isUnique!==h.isUnique&&(!0===t.isUnique?(b=new p.v({name:this.connection.namingStrategy.uniqueConstraintName(i.name,[t.name]),columnNames:[t.name]}),s.uniques.push(b),o.push(new T.A("ALTER TABLE "+this.escapePath(i)+' ADD CONSTRAINT "'+b.name+'" UNIQUE ("'+t.name+'")')),u.push(new T.A("ALTER TABLE "+this.escapePath(i)+' DROP CONSTRAINT "'+b.name+'"'))):(b=s.uniques.find(function(e){return 1===e.columnNames.length&&!!e.columnNames.find(function(e){return e===t.name})}),s.uniques.splice(s.uniques.indexOf(b),1),o.push(new T.A("ALTER TABLE "+this.escapePath(i)+' DROP CONSTRAINT "'+b.name+'"')),u.push(new T.A("ALTER TABLE "+this.escapePath(i)+' ADD CONSTRAINT "'+b.name+'" UNIQUE ("'+t.name+'")')))),t.default!==h.default&&(null!==h.default&&void 0!==h.default&&(_=this.connection.namingStrategy.defaultConstraintName(i.name,h.name),o.push(new T.A("ALTER TABLE "+this.escapePath(i)+' DROP CONSTRAINT "'+_+'"')),u.push(new T.A("ALTER TABLE "+this.escapePath(i)+' ADD CONSTRAINT "'+_+'" DEFAULT '+h.default+' FOR "'+h.name+'"'))),null!==t.default&&void 0!==t.default&&(_=this.connection.namingStrategy.defaultConstraintName(i.name,t.name),o.push(new T.A("ALTER TABLE "+this.escapePath(i)+' ADD CONSTRAINT "'+_+'" DEFAULT '+t.default+' FOR "'+t.name+'"')),u.push(new T.A("ALTER TABLE "+this.escapePath(i)+' DROP CONSTRAINT "'+_+'"')))),[4,this.executeQueries(o,u)];case 9:r.sent(),this.replaceCachedTable(i,s),r.label=10;case 10:return[2]}})})},n.prototype.changeColumns=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o,u,c;return(0,r.Jh)(this,function(h){switch(h.label){case 0:h.trys.push([0,5,6,7]),i=(t=(0,r.XA)(n)).next(),h.label=1;case 1:if(i.done)return[3,4];return s=(a=i.value).oldColumn,o=a.newColumn,[4,this.changeColumn(e,s,o)];case 2:h.sent(),h.label=3;case 3:return i=t.next(),[3,1];case 4:return[3,7];case 5:return u={error:h.sent()},[3,7];case 6:try{i&&!i.done&&(c=t.return)&&c.call(t)}finally{if(u)throw u.error}return[7];case 7:return[2]}})})},n.prototype.dropColumn=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o,u,h,l,A,p,E,f,d,N;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:if(t=i,!(a=n instanceof m.D?n:t.findColumnByName(n)))throw Error('Column "'+n+'" was not found in table "'+t.name+'"');return s=t.clone(),o=[],u=[],a.isPrimary&&(h=this.connection.namingStrategy.primaryKeyName(s.name,s.primaryColumns.map(function(e){return e.name})),l=s.primaryColumns.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new T.A("ALTER TABLE "+this.escapePath(s)+' DROP CONSTRAINT "'+h+'"')),u.push(new T.A("ALTER TABLE "+this.escapePath(s)+' ADD CONSTRAINT "'+h+'" PRIMARY KEY ('+l+")")),s.findColumnByName(a.name).isPrimary=!1,s.primaryColumns.length>0&&(A=this.connection.namingStrategy.primaryKeyName(s.name,s.primaryColumns.map(function(e){return e.name})),p=s.primaryColumns.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new T.A("ALTER TABLE "+this.escapePath(s)+' ADD CONSTRAINT "'+A+'" PRIMARY KEY ('+p+")")),u.push(new T.A("ALTER TABLE "+this.escapePath(s)+' DROP CONSTRAINT "'+A+'"')))),(E=s.indices.find(function(e){return 1===e.columnNames.length&&e.columnNames[0]===a.name}))&&(s.indices.splice(s.indices.indexOf(E),1),o.push(this.dropIndexSql(t,E)),u.push(this.createIndexSql(t,E))),(f=s.checks.find(function(e){return!!e.columnNames&&1===e.columnNames.length&&e.columnNames[0]===a.name}))&&(s.checks.splice(s.checks.indexOf(f),1),o.push(this.dropCheckConstraintSql(t,f)),u.push(this.createCheckConstraintSql(t,f))),(d=s.uniques.find(function(e){return 1===e.columnNames.length&&e.columnNames[0]===a.name}))&&(s.uniques.splice(s.uniques.indexOf(d),1),o.push(this.dropUniqueConstraintSql(t,d)),u.push(this.createUniqueConstraintSql(t,d))),null!==a.default&&void 0!==a.default&&(N=this.connection.namingStrategy.defaultConstraintName(t.name,a.name),o.push(new T.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+N+'"')),u.push(new T.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+N+'" DEFAULT '+a.default+' FOR "'+a.name+'"'))),o.push(new T.A("ALTER TABLE "+this.escapePath(t)+' DROP COLUMN "'+a.name+'"')),u.push(new T.A("ALTER TABLE "+this.escapePath(t)+" ADD "+this.buildCreateColumnSql(t,a,!1,!1))),[4,this.executeQueries(o,u)];case 4:return r.sent(),s.removeColumn(a),this.replaceCachedTable(t,s),[2]}})})},n.prototype.dropColumns=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o;return(0,r.Jh)(this,function(u){switch(u.label){case 0:u.trys.push([0,5,6,7]),i=(t=(0,r.XA)(n)).next(),u.label=1;case 1:if(i.done)return[3,4];return a=i.value,[4,this.dropColumn(e,a)];case 2:u.sent(),u.label=3;case 3:return i=t.next(),[3,1];case 4:return[3,7];case 5:return s={error:u.sent()},[3,7];case 6:try{i&&!i.done&&(o=t.return)&&o.call(t)}finally{if(s)throw s.error}return[7];case 7:return[2]}})})},n.prototype.createPrimaryKey=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:return a=(t=i).clone(),s=this.createPrimaryKeySql(t,n),a.columns.forEach(function(e){n.find(function(n){return n===e.name})&&(e.isPrimary=!0)}),o=this.dropPrimaryKeySql(a),[4,this.executeQueries(s,o)];case 4:return r.sent(),this.replaceCachedTable(t,a),[2]}})})},n.prototype.updatePrimaryKeys=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o,u,h,m,l,A,p;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:return a=(t=i).clone(),s=n.map(function(e){return e.name}),o=[],u=[],(h=a.primaryColumns).length>0&&(m=this.connection.namingStrategy.primaryKeyName(a.name,h.map(function(e){return e.name})),l=h.map(function(e){return'"'+e.name+'"'}).join(", "),o.push(new T.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+m+'"')),u.push(new T.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+m+'" PRIMARY KEY ('+l+")"))),a.columns.filter(function(e){return -1!==s.indexOf(e.name)}).forEach(function(e){return e.isPrimary=!0}),A=this.connection.namingStrategy.primaryKeyName(a.name,s),p=s.map(function(e){return'"'+e+'"'}).join(", "),o.push(new T.A("ALTER TABLE "+this.escapePath(t)+' ADD CONSTRAINT "'+A+'" PRIMARY KEY ('+p+")")),u.push(new T.A("ALTER TABLE "+this.escapePath(t)+' DROP CONSTRAINT "'+A+'"')),[4,this.executeQueries(o,u)];case 4:return r.sent(),this.replaceCachedTable(t,a),[2]}})})},n.prototype.dropPrimaryKey=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,i,a;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return t=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:t=r.sent(),r.label=3;case 3:return n=t,i=this.dropPrimaryKeySql(n),a=this.createPrimaryKeySql(n,n.primaryColumns.map(function(e){return e.name})),[4,this.executeQueries(i,a)];case 4:return r.sent(),n.primaryColumns.forEach(function(e){e.isPrimary=!1}),[2]}})})},n.prototype.createUniqueConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:return t=i,n.name||(n.name=this.connection.namingStrategy.uniqueConstraintName(t.name,n.columnNames)),a=this.createUniqueConstraintSql(t,n),s=this.dropUniqueConstraintSql(t,n),[4,this.executeQueries(a,s)];case 4:return r.sent(),t.addUniqueConstraint(n),[2]}})})},n.prototype.createUniqueConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.createUniqueConstraint(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.dropUniqueConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:if(t=i,!(a=n instanceof p.v?n:t.uniques.find(function(e){return e.name===n})))throw Error("Supplied unique constraint was not found in table "+t.name);return s=this.dropUniqueConstraintSql(t,a),o=this.createUniqueConstraintSql(t,a),[4,this.executeQueries(s,o)];case 4:return r.sent(),t.removeUniqueConstraint(a),[2]}})})},n.prototype.dropUniqueConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.dropUniqueConstraint(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.createCheckConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:return t=i,n.name||(n.name=this.connection.namingStrategy.checkConstraintName(t.name,n.expression)),a=this.createCheckConstraintSql(t,n),s=this.dropCheckConstraintSql(t,n),[4,this.executeQueries(a,s)];case 4:return r.sent(),t.addCheckConstraint(n),[2]}})})},n.prototype.createCheckConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.createCheckConstraint(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.dropCheckConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:if(t=i,!(a=n instanceof h.r?n:t.checks.find(function(e){return e.name===n})))throw Error("Supplied check constraint was not found in table "+t.name);return s=this.dropCheckConstraintSql(t,a),o=this.createCheckConstraintSql(t,a),[4,this.executeQueries(s,o)];case 4:return r.sent(),t.removeCheckConstraint(a),[2]}})})},n.prototype.dropCheckConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.dropCheckConstraint(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.createExclusionConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){throw Error("SqlServer does not support exclusion constraints.")})})},n.prototype.createExclusionConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){throw Error("SqlServer does not support exclusion constraints.")})})},n.prototype.dropExclusionConstraint=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){throw Error("SqlServer does not support exclusion constraints.")})})},n.prototype.dropExclusionConstraints=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){throw Error("SqlServer does not support exclusion constraints.")})})},n.prototype.createForeignKey=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:return t=i,n.name||(n.name=this.connection.namingStrategy.foreignKeyName(t.name,n.columnNames,n.referencedTableName,n.referencedColumnNames)),a=this.createForeignKeySql(t,n),s=this.dropForeignKeySql(t,n),[4,this.executeQueries(a,s)];case 4:return r.sent(),t.addForeignKey(n),[2]}})})},n.prototype.createForeignKeys=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.createForeignKey(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.dropForeignKey=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:if(t=i,!(a=n instanceof l.U?n:t.foreignKeys.find(function(e){return e.name===n})))throw Error("Supplied foreign key was not found in table "+t.name);return s=this.dropForeignKeySql(t,a),o=this.createForeignKeySql(t,a),[4,this.executeQueries(s,o)];case 4:return r.sent(),t.removeForeignKey(a),[2]}})})},n.prototype.dropForeignKeys=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.dropForeignKey(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.createIndex=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:return t=i,n.name||(n.name=this.connection.namingStrategy.indexName(t.name,n.columnNames,n.where)),a=this.createIndexSql(t,n),s=this.dropIndexSql(t,n),[4,this.executeQueries(a,s)];case 4:return r.sent(),t.addIndex(n),[2]}})})},n.prototype.createIndices=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.createIndex(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.dropIndex=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t,i,a,s,o;return(0,r.Jh)(this,function(r){switch(r.label){case 0:if(!(e instanceof c.i))return[3,1];return i=e,[3,3];case 1:return[4,this.getCachedTable(e)];case 2:i=r.sent(),r.label=3;case 3:if(t=i,!(a=n instanceof A.s?n:t.indices.find(function(e){return e.name===n})))throw Error("Supplied index was not found in table "+t.name);return s=this.dropIndexSql(t,a),o=this.createIndexSql(t,a),[4,this.executeQueries(s,o)];case 4:return r.sent(),t.removeIndex(a),[2]}})})},n.prototype.dropIndices=function(e,n){return(0,r.mG)(this,void 0,void 0,function(){var t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return[4,Promise.all(n.map(function(n){return t.dropIndex(e,n)}))];case 1:return r.sent(),[2]}})})},n.prototype.clearTable=function(e){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(n){switch(n.label){case 0:return[4,this.query("TRUNCATE TABLE "+this.escapePath(e))];case 1:return n.sent(),[2]}})})},n.prototype.clearDatabase=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,i,a,s=this;return(0,r.Jh)(this,function(o){switch(o.label){case 0:if(!e)return[3,2];return[4,this.hasDatabase(e)];case 1:if(!o.sent())return[2,Promise.resolve()];o.label=2;case 2:return[4,this.startTransaction()];case 3:o.sent(),o.label=4;case 4:return o.trys.push([4,11,,16]),n=e?'SELECT * FROM "'+e+'"."INFORMATION_SCHEMA"."VIEWS"':'SELECT * FROM "INFORMATION_SCHEMA"."VIEWS"',[4,this.query(n)];case 5:return[4,Promise.all(o.sent().map(function(e){var n='DROP VIEW "'+e.TABLE_SCHEMA+'"."'+e.TABLE_NAME+'"';return s.query(n)}))];case 6:return o.sent(),t=e?'SELECT * FROM "'+e+'"."INFORMATION_SCHEMA"."TABLES" WHERE "TABLE_TYPE" = \'BASE TABLE\'':'SELECT * FROM "INFORMATION_SCHEMA"."TABLES" WHERE "TABLE_TYPE" = \'BASE TABLE\'',[4,this.query(t)];case 7:return[4,Promise.all((i=o.sent()).map(function(e){return(0,r.mG)(s,void 0,void 0,function(){var n,t=this;return(0,r.Jh)(this,function(r){switch(r.label){case 0:return n="SELECT 'ALTER TABLE \""+e.TABLE_CATALOG+'"."\' + OBJECT_SCHEMA_NAME("fk"."parent_object_id", DB_ID(\''+e.TABLE_CATALOG+'\')) + \'"."\' + OBJECT_NAME("fk"."parent_object_id", DB_ID(\''+e.TABLE_CATALOG+'\')) + \'" DROP CONSTRAINT "\' + "fk"."name" + \'"\' as "query" FROM "'+e.TABLE_CATALOG+'"."sys"."foreign_keys" AS "fk" '+('WHERE "fk"."referenced_object_id" = OBJECT_ID(\'"'+e.TABLE_CATALOG+'"."'+e.TABLE_SCHEMA)+'"."'+e.TABLE_NAME+"\"')",[4,this.query(n)];case 1:return[2,Promise.all(r.sent().map(function(e){return e.query}).map(function(e){return t.query(e)}))]}})})}))];case 8:return o.sent(),[4,Promise.all(i.map(function(e){if(!e.TABLE_NAME.startsWith("#")){var n='DROP TABLE "'+e.TABLE_CATALOG+'"."'+e.TABLE_SCHEMA+'"."'+e.TABLE_NAME+'"';return s.query(n)}}))];case 9:return o.sent(),[4,this.commitTransaction()];case 10:return o.sent(),[3,16];case 11:a=o.sent(),o.label=12;case 12:return o.trys.push([12,14,,15]),[4,this.rollbackTransaction()];case 13:case 14:return o.sent(),[3,15];case 15:throw a;case 16:return[2]}})})},n.prototype.getCurrentDatabase=function(){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){switch(e.label){case 0:return[4,this.query('SELECT DB_NAME() AS "db_name"')];case 1:return[2,e.sent()[0].db_name]}})})},n.prototype.getCurrentSchema=function(){return(0,r.mG)(this,void 0,void 0,function(){return(0,r.Jh)(this,function(e){switch(e.label){case 0:return[4,this.query('SELECT SCHEMA_NAME() AS "schema_name"')];case 1:return[2,e.sent()[0].schema_name]}})})},n.prototype.loadViews=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,i,a,s,o,u=this;return(0,r.Jh)(this,function(c){switch(c.label){case 0:return[4,this.hasTable(this.getTypeormMetadataTableName())];case 1:if(!c.sent())return[2,Promise.resolve([])];return[4,this.getCurrentSchema()];case 2:return n=c.sent(),[4,this.getCurrentDatabase()];case 3:return t=c.sent(),i=function(e){var t=(0,r.CR)(e.split("."),3),i=t[0],a=t[1],s=t[2];return s?""===a&&(a=u.driver.options.schema||n):a?(s=a,a=i):(s=i,a=u.driver.options.schema||n),[a,s]},a=e.filter(function(e){return 3===e.split(".").length}).map(function(e){return e.split(".")[0]}),this.driver.database&&!a.find(function(e){return e===u.driver.database})&&a.push(this.driver.database),s=e.map(function(e){var n=(0,r.CR)(i(e),2);return'("T"."SCHEMA" = \''+n[0]+'\' AND "T"."NAME" = \''+n[1]+"')"}).join(" OR "),o=a.map(function(e){return'SELECT "T".*, "V"."CHECK_OPTION" FROM '+u.escapePath(u.getTypeormMetadataTableName())+' "t" INNER JOIN "'+e+'"."INFORMATION_SCHEMA"."VIEWS" "V" ON "V"."TABLE_SCHEMA" = "T"."SCHEMA" AND "v"."TABLE_NAME" = "T"."NAME" WHERE "T"."TYPE" = \'VIEW\' '+(s?"AND ("+s+")":"")}).join(" UNION ALL "),[4,this.query(o)];case 4:return[2,c.sent().map(function(e){var r=new E.G,i=e.TABLE_CATALOG===t?void 0:e.TABLE_CATALOG,a=e.schema!==n||u.driver.options.schema?e.schema:void 0;return r.name=u.driver.buildTableName(e.name,a,i),r.expression=e.value,r})]}})})},n.prototype.loadTables=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,i,a,s,o,u,E,f,T,N,C,v,y,S,R,L,O,b,_,I,w,g=this;return(0,r.Jh)(this,function(M){switch(M.label){case 0:if(!e||!e.length)return[2,[]];return n=[],[4,this.getCurrentSchema()];case 1:return t=M.sent(),[4,this.getCurrentDatabase()];case 2:return i=M.sent(),a=function(e){var n=(0,r.CR)(e.split("."),3),i=n[0],a=n[1],s=n[2];return s?""===a&&(a=g.driver.options.schema||t):a?(s=a,a=i):(s=i,a=g.driver.options.schema||t),[a,s]},e.filter(function(e){return -1!==e.indexOf(".")}).forEach(function(e){3===e.split(".").length?""!==e.split(".")[1]&&n.push(e.split(".")[1]):n.push(e.split(".")[0])}),n.push(this.driver.options.schema||t),s=e.filter(function(e){return 3===e.split(".").length}).map(function(e){return e.split(".")[0]}),this.driver.database&&!s.find(function(e){return e===g.driver.database})&&s.push(this.driver.database),o=n.map(function(e){return"'"+e+"'"}).join(", "),u=e.map(function(e){var n=(0,r.CR)(a(e),2);return'("TABLE_SCHEMA" = \''+n[0]+"' AND \"TABLE_NAME\" = '"+n[1]+"')"}).join(" OR "),E=s.map(function(e){return'SELECT * FROM "'+e+'"."INFORMATION_SCHEMA"."TABLES" WHERE '+u}).join(" UNION ALL "),f=s.map(function(e){return'SELECT * FROM "'+e+'"."INFORMATION_SCHEMA"."COLUMNS" WHERE '+u}).join(" UNION ALL "),T=e.map(function(e){var n=(0,r.CR)(a(e),2),t=n[0],i=n[1];return'("columnUsages"."TABLE_SCHEMA" = \''+t+'\' AND "columnUsages"."TABLE_NAME" = \''+i+"' "+('AND "tableConstraints"."TABLE_SCHEMA" = \''+t)+'\' AND "tableConstraints"."TABLE_NAME" = \''+i+"')"}).join(" OR "),N=s.map(function(e){return'SELECT "columnUsages".*, "tableConstraints"."CONSTRAINT_TYPE", "chk"."definition" FROM "'+e+'"."INFORMATION_SCHEMA"."CONSTRAINT_COLUMN_USAGE" "columnUsages" INNER JOIN "'+e+'"."INFORMATION_SCHEMA"."TABLE_CONSTRAINTS" "tableConstraints" ON "tableConstraints"."CONSTRAINT_NAME" = "columnUsages"."CONSTRAINT_NAME" LEFT JOIN "'+e+'"."sys"."check_constraints" "chk" ON "chk"."name" = "columnUsages"."CONSTRAINT_NAME" WHERE ('+T+") AND \"tableConstraints\".\"CONSTRAINT_TYPE\" IN ('PRIMARY KEY', 'UNIQUE', 'CHECK')"}).join(" UNION ALL "),C=s.map(function(e){return'SELECT "fk"."name" AS "FK_NAME", \''+e+'\' AS "TABLE_CATALOG", "s1"."name" AS "TABLE_SCHEMA", "t1"."name" AS "TABLE_NAME", "col1"."name" AS "COLUMN_NAME", "s2"."name" AS "REF_SCHEMA", "t2"."name" AS "REF_TABLE", "col2"."name" AS "REF_COLUMN", "fk"."delete_referential_action_desc" AS "ON_DELETE", "fk"."update_referential_action_desc" AS "ON_UPDATE" FROM "'+e+'"."sys"."foreign_keys" "fk" INNER JOIN "'+e+'"."sys"."foreign_key_columns" "fkc" ON "fkc"."constraint_object_id" = "fk"."object_id" INNER JOIN "'+e+'"."sys"."tables" "t1" ON "t1"."object_id" = "fk"."parent_object_id" INNER JOIN "'+e+'"."sys"."schemas" "s1" ON "s1"."schema_id" = "t1"."schema_id" INNER JOIN "'+e+'"."sys"."tables" "t2" ON "t2"."object_id" = "fk"."referenced_object_id" INNER JOIN "'+e+'"."sys"."schemas" "s2" ON "s2"."schema_id" = "t2"."schema_id" INNER JOIN "'+e+'"."sys"."columns" "col1" ON "col1"."column_id" = "fkc"."parent_column_id" AND "col1"."object_id" = "fk"."parent_object_id" INNER JOIN "'+e+'"."sys"."columns" "col2" ON "col2"."column_id" = "fkc"."referenced_column_id" AND "col2"."object_id" = "fk"."referenced_object_id"'}).join(" UNION ALL "),v=s.map(function(e){return'SELECT "TABLE_CATALOG", "TABLE_SCHEMA", "COLUMN_NAME", "TABLE_NAME" FROM "'+e+'"."INFORMATION_SCHEMA"."COLUMNS" WHERE COLUMNPROPERTY(object_id("TABLE_CATALOG" + \'.\' + "TABLE_SCHEMA" + \'.\' + "TABLE_NAME"), "COLUMN_NAME", \'IsIdentity\') = 1 AND "TABLE_SCHEMA" IN ('+o+")"}).join(" UNION ALL "),y=s.map(function(e){return"SELECT '"+e+'\' AS "TABLE_CATALOG", "s"."name" AS "TABLE_SCHEMA", "t"."name" AS "TABLE_NAME", "ind"."name" AS "INDEX_NAME", "col"."name" AS "COLUMN_NAME", "ind"."is_unique" AS "IS_UNIQUE", "ind"."filter_definition" as "CONDITION" FROM "'+e+'"."sys"."indexes" "ind" INNER JOIN "'+e+'"."sys"."index_columns" "ic" ON "ic"."object_id" = "ind"."object_id" AND "ic"."index_id" = "ind"."index_id" INNER JOIN "'+e+'"."sys"."columns" "col" ON "col"."object_id" = "ic"."object_id" AND "col"."column_id" = "ic"."column_id" INNER JOIN "'+e+'"."sys"."tables" "t" ON "t"."object_id" = "ind"."object_id" INNER JOIN "'+e+'"."sys"."schemas" "s" ON "s"."schema_id" = "t"."schema_id" WHERE "ind"."is_primary_key" = 0 AND "ind"."is_unique_constraint" = 0 AND "t"."is_ms_shipped" = 0'}).join(" UNION ALL "),[4,Promise.all([this.query(E),this.query(f),this.query(N),this.query(C),this.query(v),this.query('SELECT "NAME", "COLLATION_NAME" FROM "sys"."databases"'),this.query(y)])];case 3:if(R=(S=r.CR.apply(void 0,[M.sent(),7]))[0],L=S[1],O=S[2],b=S[3],_=S[4],I=S[5],w=S[6],!R.length)return[2,[]];return[4,Promise.all(R.map(function(e){return(0,r.mG)(g,void 0,void 0,function(){var n,a,s,o,u,E,f,T,N,C=this;return(0,r.Jh)(this,function(v){return n=new c.i,a=e.TABLE_CATALOG===i?void 0:e.TABLE_CATALOG,s=e.TABLE_SCHEMA!==t||this.driver.options.schema?e.TABLE_SCHEMA:void 0,n.name=this.driver.buildTableName(e.TABLE_NAME,s,a),o=this.driver.buildTableName(e.TABLE_NAME,e.TABLE_SCHEMA,e.TABLE_CATALOG),u=I.find(function(n){return n.NAME===e.TABLE_CATALOG}),n.columns=L.filter(function(e){return C.driver.buildTableName(e.TABLE_NAME,e.TABLE_SCHEMA,e.TABLE_CATALOG)===o}).map(function(e){var t,i,a=O.filter(function(n){return C.driver.buildTableName(n.TABLE_NAME,n.CONSTRAINT_SCHEMA,n.CONSTRAINT_CATALOG)===o&&n.COLUMN_NAME===e.COLUMN_NAME}),s=a.find(function(e){return"UNIQUE"===e.CONSTRAINT_TYPE}),c=!!s&&!!O.find(function(n){return"UNIQUE"===n.CONSTRAINT_TYPE&&n.CONSTRAINT_NAME===s.CONSTRAINT_NAME&&n.COLUMN_NAME!==e.COLUMN_NAME}),h=!!a.find(function(e){return"PRIMARY KEY"===e.CONSTRAINT_TYPE}),l=!!_.find(function(n){return C.driver.buildTableName(n.TABLE_NAME,n.TABLE_SCHEMA,n.TABLE_CATALOG)===o&&n.COLUMN_NAME===e.COLUMN_NAME}),A=new m.D;if(A.name=e.COLUMN_NAME,A.type=e.DATA_TYPE.toLowerCase(),-1!==C.driver.withLengthColumnTypes.indexOf(A.type)&&e.CHARACTER_MAXIMUM_LENGTH){var p=e.CHARACTER_MAXIMUM_LENGTH.toString();"-1"===p?A.length="MAX":A.length=C.isDefaultColumnLength(n,A,p)?"":p}if("decimal"!==A.type&&"numeric"!==A.type||(null===e.NUMERIC_PRECISION||C.isDefaultColumnPrecision(n,A,e.NUMERIC_PRECISION)||(A.precision=e.NUMERIC_PRECISION),null===e.NUMERIC_SCALE||C.isDefaultColumnScale(n,A,e.NUMERIC_SCALE)||(A.scale=e.NUMERIC_SCALE)),"nvarchar"===A.type){var E=a.filter(function(e){return"CHECK"===e.CONSTRAINT_TYPE});if(E.length){var f=RegExp("^\\(\\["+A.name+"\\]='[^']+'(?: OR \\["+A.name+"\\]='[^']+')*\\)$");try{for(var d=(0,r.XA)(E),T=d.next();!T.done;T=d.next()){var N=T.value;if(f.test(N.definition)){A.type="simple-enum",A.enum=[];for(var v=RegExp("\\["+A.name+"\\]='([^']+)'","g"),y=void 0;null!==(y=v.exec(N.definition));)A.enum.unshift(y[1]);break}}}catch(e){t={error:e}}finally{try{T&&!T.done&&(i=d.return)&&i.call(d)}finally{if(t)throw t.error}}}}return A.default=null!==e.COLUMN_DEFAULT&&void 0!==e.COLUMN_DEFAULT?C.removeParenthesisFromDefault(e.COLUMN_DEFAULT):void 0,A.isNullable="YES"===e.IS_NULLABLE,A.isPrimary=h,A.isUnique=!!s&&!c,A.isGenerated=l,l&&(A.generationStrategy="increment"),"newsequentialid()"===A.default&&(A.isGenerated=!0,A.generationStrategy="uuid",A.default=void 0),e.COLLATION_NAME&&(A.collation=e.COLLATION_NAME===u.COLLATION_NAME?void 0:e.COLLATION_NAME),("datetime2"===A.type||"time"===A.type||"datetimeoffset"===A.type)&&(A.precision=C.isDefaultColumnPrecision(n,A,e.DATETIME_PRECISION)?void 0:e.DATETIME_PRECISION),A}),E=d.s.uniq(O.filter(function(e){return C.driver.buildTableName(e.TABLE_NAME,e.CONSTRAINT_SCHEMA,e.CONSTRAINT_CATALOG)===o&&"UNIQUE"===e.CONSTRAINT_TYPE}),function(e){return e.CONSTRAINT_NAME}),n.uniques=E.map(function(e){var n=O.filter(function(n){return n.CONSTRAINT_NAME===e.CONSTRAINT_NAME});return new p.v({name:e.CONSTRAINT_NAME,columnNames:n.map(function(e){return e.COLUMN_NAME})})}),f=d.s.uniq(O.filter(function(e){return C.driver.buildTableName(e.TABLE_NAME,e.CONSTRAINT_SCHEMA,e.CONSTRAINT_CATALOG)===o&&"CHECK"===e.CONSTRAINT_TYPE}),function(e){return e.CONSTRAINT_NAME}),n.checks=f.map(function(e){var n=O.filter(function(n){return n.CONSTRAINT_NAME===e.CONSTRAINT_NAME});return new h.r({name:e.CONSTRAINT_NAME,columnNames:n.map(function(e){return e.COLUMN_NAME}),expression:e.definition})}),T=d.s.uniq(b.filter(function(e){return C.driver.buildTableName(e.TABLE_NAME,e.TABLE_SCHEMA,e.TABLE_CATALOG)===o}),function(e){return e.FK_NAME}),n.foreignKeys=T.map(function(e){var n=b.filter(function(n){return n.FK_NAME===e.FK_NAME}),r=e.TABLE_CATALOG===i?void 0:e.TABLE_CATALOG,a=e.REF_SCHEMA===t?void 0:e.REF_SCHEMA,s=C.driver.buildTableName(e.REF_TABLE,a,r);return new l.U({name:e.FK_NAME,columnNames:n.map(function(e){return e.COLUMN_NAME}),referencedTableName:s,referencedColumnNames:n.map(function(e){return e.REF_COLUMN}),onDelete:e.ON_DELETE.replace("_"," "),onUpdate:e.ON_UPDATE.replace("_"," ")})}),N=d.s.uniq(w.filter(function(e){return C.driver.buildTableName(e.TABLE_NAME,e.TABLE_SCHEMA,e.TABLE_CATALOG)===o}),function(e){return e.INDEX_NAME}),n.indices=N.map(function(e){var t=w.filter(function(n){return n.TABLE_CATALOG===e.TABLE_CATALOG&&n.TABLE_SCHEMA===e.TABLE_SCHEMA&&n.TABLE_NAME===e.TABLE_NAME&&n.INDEX_NAME===e.INDEX_NAME});return new A.s({table:n,name:e.INDEX_NAME,columnNames:t.map(function(e){return e.COLUMN_NAME}),isUnique:e.IS_UNIQUE,where:e.CONDITION})}),[2,n]})})}))];case 4:return[2,M.sent()]}})})},n.prototype.createTableSql=function(e,n){var t=this,r=e.columns.map(function(n){return t.buildCreateColumnSql(e,n,!1,!0)}).join(", "),i="CREATE TABLE "+this.escapePath(e)+" ("+r;e.columns.filter(function(e){return e.isUnique}).forEach(function(n){e.uniques.some(function(e){return 1===e.columnNames.length&&e.columnNames[0]===n.name})||e.uniques.push(new p.v({name:t.connection.namingStrategy.uniqueConstraintName(e.name,[n.name]),columnNames:[n.name]}))}),e.uniques.length>0&&(i+=", "+e.uniques.map(function(n){return'CONSTRAINT "'+(n.name?n.name:t.connection.namingStrategy.uniqueConstraintName(e.name,n.columnNames))+'" UNIQUE ('+n.columnNames.map(function(e){return'"'+e+'"'}).join(", ")+")"}).join(", ")),e.checks.length>0&&(i+=", "+e.checks.map(function(n){return'CONSTRAINT "'+(n.name?n.name:t.connection.namingStrategy.checkConstraintName(e.name,n.expression))+'" CHECK ('+n.expression+")"}).join(", ")),e.foreignKeys.length>0&&n&&(i+=", "+e.foreignKeys.map(function(n){var r=n.columnNames.map(function(e){return'"'+e+'"'}).join(", ");n.name||(n.name=t.connection.namingStrategy.foreignKeyName(e.name,n.columnNames,n.referencedTableName,n.referencedColumnNames));var i=n.referencedColumnNames.map(function(e){return'"'+e+'"'}).join(", "),a='CONSTRAINT "'+n.name+'" FOREIGN KEY ('+r+") REFERENCES "+t.escapePath(n.referencedTableName)+" ("+i+")";return n.onDelete&&(a+=" ON DELETE "+n.onDelete),n.onUpdate&&(a+=" ON UPDATE "+n.onUpdate),a}).join(", "));var a=e.columns.filter(function(e){return e.isPrimary});return a.length>0&&(i+=', CONSTRAINT "'+this.connection.namingStrategy.primaryKeyName(e.name,a.map(function(e){return e.name}))+'" PRIMARY KEY ('+a.map(function(e){return'"'+e.name+'"'}).join(", ")+")"),i+=")",new T.A(i)},n.prototype.dropTableSql=function(e,n){var t=n?"DROP TABLE IF EXISTS "+this.escapePath(e):"DROP TABLE "+this.escapePath(e);return new T.A(t)},n.prototype.createViewSql=function(e){return new T.A("string"==typeof e.expression?"CREATE VIEW "+this.escapePath(e)+" AS "+e.expression:"CREATE VIEW "+this.escapePath(e)+" AS "+e.expression(this.connection).getQuery())},n.prototype.insertViewDefinitionSql=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,i,a,s,o;return(0,r.Jh)(this,function(u){switch(u.label){case 0:return[4,this.getCurrentSchema()];case 1:return n=u.sent(),t=this.parseTableName(e,n),i="string"==typeof e.expression?e.expression.trim():e.expression(this.connection).getQuery(),s=(a=(0,r.CR)(this.connection.createQueryBuilder().insert().into(this.getTypeormMetadataTableName()).values({type:"VIEW",database:t.database,schema:t.schema,name:t.name,value:i}).getQueryAndParameters(),2))[0],o=a[1],[2,new T.A(s,o)]}})})},n.prototype.dropViewSql=function(e){return new T.A("DROP VIEW "+this.escapePath(e))},n.prototype.deleteViewDefinitionSql=function(e){return(0,r.mG)(this,void 0,void 0,function(){var n,t,i,a,s,o;return(0,r.Jh)(this,function(u){switch(u.label){case 0:return[4,this.getCurrentSchema()];case 1:return n=u.sent(),t=this.parseTableName(e,n),i=this.connection.createQueryBuilder(),s=(a=(0,r.CR)(i.delete().from(this.getTypeormMetadataTableName()).where(i.escape("type")+" = 'VIEW'").andWhere(i.escape("database")+" = :database",{database:t.database}).andWhere(i.escape("schema")+" = :schema",{schema:t.schema}).andWhere(i.escape("name")+" = :name",{name:t.name}).getQueryAndParameters(),2))[0],o=a[1],[2,new T.A(s,o)]}})})},n.prototype.createIndexSql=function(e,n){var t=n.columnNames.map(function(e){return'"'+e+'"'}).join(", ");return new T.A("CREATE "+(n.isUnique?"UNIQUE ":"")+'INDEX "'+n.name+'" ON '+this.escapePath(e)+" ("+t+") "+(n.where?"WHERE "+n.where:""))},n.prototype.dropIndexSql=function(e,n){var t=n instanceof A.s?n.name:n;return new T.A('DROP INDEX "'+t+'" ON '+this.escapePath(e))},n.prototype.createPrimaryKeySql=function(e,n){var t=this.connection.namingStrategy.primaryKeyName(e.name,n),r=n.map(function(e){return'"'+e+'"'}).join(", ");return new T.A("ALTER TABLE "+this.escapePath(e)+' ADD CONSTRAINT "'+t+'" PRIMARY KEY ('+r+")")},n.prototype.dropPrimaryKeySql=function(e){var n=e.primaryColumns.map(function(e){return e.name}),t=this.connection.namingStrategy.primaryKeyName(e.name,n);return new T.A("ALTER TABLE "+this.escapePath(e)+' DROP CONSTRAINT "'+t+'"')},n.prototype.createUniqueConstraintSql=function(e,n){var t=n.columnNames.map(function(e){return'"'+e+'"'}).join(", ");return new T.A("ALTER TABLE "+this.escapePath(e)+' ADD CONSTRAINT "'+n.name+'" UNIQUE ('+t+")")},n.prototype.dropUniqueConstraintSql=function(e,n){var t=n instanceof p.v?n.name:n;return new T.A("ALTER TABLE "+this.escapePath(e)+' DROP CONSTRAINT "'+t+'"')},n.prototype.createCheckConstraintSql=function(e,n){return new T.A("ALTER TABLE "+this.escapePath(e)+' ADD CONSTRAINT "'+n.name+'" CHECK ('+n.expression+")")},n.prototype.dropCheckConstraintSql=function(e,n){var t=n instanceof h.r?n.name:n;return new T.A("ALTER TABLE "+this.escapePath(e)+' DROP CONSTRAINT "'+t+'"')},n.prototype.createForeignKeySql=function(e,n){var t=n.columnNames.map(function(e){return'"'+e+'"'}).join(", "),r=n.referencedColumnNames.map(function(e){return'"'+e+'"'}).join(","),i="ALTER TABLE "+this.escapePath(e)+' ADD CONSTRAINT "'+n.name+'" FOREIGN KEY ('+t+") "+("REFERENCES "+this.escapePath(n.referencedTableName))+"("+r+")";return n.onDelete&&(i+=" ON DELETE "+n.onDelete),n.onUpdate&&(i+=" ON UPDATE "+n.onUpdate),new T.A(i)},n.prototype.dropForeignKeySql=function(e,n){var t=n instanceof l.U?n.name:n;return new T.A("ALTER TABLE "+this.escapePath(e)+' DROP CONSTRAINT "'+t+'"')},n.prototype.escapePath=function(e,n){var t=e instanceof c.i||e instanceof E.G?e.name:e;if(this.driver.options.schema){if(-1===t.indexOf("."))t=this.driver.options.schema+"."+t;else if(3===t.split(".").length){var r=t.split("."),i=r[0],a=r[2];t=i+"."+this.driver.options.schema+"."+a}}return t.split(".").map(function(e){return""===e?e:n?e:'"'+e+'"'}).join(".")},n.prototype.parseTableName=function(e,n){var t=e instanceof c.i||e instanceof E.G?e.name:e;return 3===t.split(".").length?{database:t.split(".")[0],schema:""===t.split(".")[1]?n||"SCHEMA_NAME()":t.split(".")[1],name:t.split(".")[2]}:2===t.split(".").length?{database:this.driver.database,schema:t.split(".")[0],name:t.split(".")[1]}:{database:this.driver.database,schema:this.driver.options.schema?this.driver.options.schema:n||"SCHEMA_NAME()",name:t}},n.prototype.buildForeignKeyName=function(e,n,t){var r=e;return n&&(r=n+"."+r),t&&(r=t+"."+r),r},n.prototype.removeParenthesisFromDefault=function(e){if("("!==e.substr(0,1))return e;var n=e.substr(1,e.lastIndexOf(")")-1);return this.removeParenthesisFromDefault(n)},n.prototype.buildCreateColumnSql=function(e,n,t,r){var i='"'+n.name+'" '+this.connection.driver.createFullType(n);if(n.enum&&(i+=" CHECK( "+n.name+" IN ("+n.enum.map(function(e){return"'"+e+"'"}).join(",")+") )"),n.collation&&(i+=" COLLATE "+n.collation),!0!==n.isNullable&&(i+=" NOT NULL"),!0!==n.isGenerated||"increment"!==n.generationStrategy||t||(i+=" IDENTITY(1,1)"),void 0!==n.default&&null!==n.default&&r){var a=this.connection.namingStrategy.defaultConstraintName(e.name,n.name);i+=' CONSTRAINT "'+a+'" DEFAULT '+n.default}if(n.isGenerated&&"uuid"===n.generationStrategy&&!n.default){var a=this.connection.namingStrategy.defaultConstraintName(e.name,n.name);i+=' CONSTRAINT "'+a+'" DEFAULT NEWSEQUENTIALID()'}return i},n.prototype.mssqlParameterToNativeParameter=function(e){var n,t,i,a,s,o,u,c,h,m;switch(this.driver.normalizeType({type:e.type})){case"bit":return this.driver.mssql.Bit;case"bigint":return this.driver.mssql.BigInt;case"decimal":return(n=this.driver.mssql).Decimal.apply(n,(0,r.fl)(e.params));case"float":return this.driver.mssql.Float;case"int":return this.driver.mssql.Int;case"money":return this.driver.mssql.Money;case"numeric":return(t=this.driver.mssql).Numeric.apply(t,(0,r.fl)(e.params));case"smallint":return this.driver.mssql.SmallInt;case"smallmoney":return this.driver.mssql.SmallMoney;case"real":return this.driver.mssql.Real;case"tinyint":return this.driver.mssql.TinyInt;case"char":return(i=this.driver.mssql).Char.apply(i,(0,r.fl)(e.params));case"nchar":return(a=this.driver.mssql).NChar.apply(a,(0,r.fl)(e.params));case"text":return this.driver.mssql.Text;case"ntext":return this.driver.mssql.Ntext;case"varchar":return(s=this.driver.mssql).VarChar.apply(s,(0,r.fl)(e.params));case"nvarchar":return(o=this.driver.mssql).NVarChar.apply(o,(0,r.fl)(e.params));case"xml":return this.driver.mssql.Xml;case"time":return(u=this.driver.mssql).Time.apply(u,(0,r.fl)(e.params));case"date":return this.driver.mssql.Date;case"datetime":return this.driver.mssql.DateTime;case"datetime2":return(c=this.driver.mssql).DateTime2.apply(c,(0,r.fl)(e.params));case"datetimeoffset":return(h=this.driver.mssql).DateTimeOffset.apply(h,(0,r.fl)(e.params));case"smalldatetime":return this.driver.mssql.SmallDateTime;case"uniqueidentifier":return this.driver.mssql.UniqueIdentifier;case"variant":return this.driver.mssql.Variant;case"binary":return this.driver.mssql.Binary;case"varbinary":return(m=this.driver.mssql).VarBinary.apply(m,(0,r.fl)(e.params));case"image":return this.driver.mssql.Image;case"udt":return this.driver.mssql.UDT;case"rowversion":return this.driver.mssql.RowVersion}},n.prototype.convertIsolationLevel=function(e){var n=this.driver.mssql.ISOLATION_LEVEL;switch(e){case"READ UNCOMMITTED":return n.READ_UNCOMMITTED;case"REPEATABLE READ":return n.REPEATABLE_READ;case"SERIALIZABLE":return n.SERIALIZABLE;default:return n.READ_COMMITTED}},n}(u.Y)}}]);